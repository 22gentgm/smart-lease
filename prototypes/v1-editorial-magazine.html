<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Lease — UT Knoxville Student Housing</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        cream: '#FAF8F5',
        'cream-dark': '#F5F3F0',
        ink: '#1A1A1A',
        'ut-orange': '#FF8200',
        'ut-orange-light': '#FF9E33',
        'smokey-gray': '#4B4B4B',
        'smokey-light': '#6B6B6B',
      },
      fontFamily: {
        serif: ['Playfair Display', 'Georgia', 'serif'],
        sans: ['Space Grotesk', 'system-ui', 'sans-serif'],
      }
    }
  }
}
</script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  html { scroll-behavior: smooth; }
  
  body {
    font-family: 'Space Grotesk', sans-serif;
    background: #E8E4DF;
    /* UT Knoxville: orange & smokey gray accents */
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 20px 0;
  }

  /* Phone frame */
  #phone-frame {
    width: 430px;
    max-width: 430px;
    min-height: 100vh;
    background: #FAF8F5;
    position: relative;
    overflow: hidden;
    box-shadow: 0 25px 80px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
    border-radius: 40px;
  }

  /* Scrollable inner */
  #app-scroll {
    height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
    scroll-snap-type: y proximity;
    -webkit-overflow-scrolling: touch;
  }

  #app-scroll::-webkit-scrollbar { width: 0; }

  /* Typography */
  .font-editorial { font-family: 'Playfair Display', Georgia, serif; }
  .font-body { font-family: 'Space Grotesk', sans-serif; }

  .small-caps {
    font-variant: small-caps;
    letter-spacing: 0.15em;
    text-transform: lowercase;
  }

  /* Progress bar */
  #progress-bar {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 430px;
    height: 2px;
    background: rgba(26,26,26,0.06);
    z-index: 100;
    opacity: 0;
    transition: opacity 0.6s ease;
  }
  #progress-bar.visible { opacity: 1; }
  #progress-fill {
    height: 100%;
    width: 0%;
    background: #FF8200;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Section transitions */
  .section-screen {
    min-height: 100vh;
    position: relative;
  }

  /* Fade-up animation */
  .fade-up {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .fade-up.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .fade-up-delay-1 { transition-delay: 0.15s; }
  .fade-up-delay-2 { transition-delay: 0.3s; }
  .fade-up-delay-3 { transition-delay: 0.45s; }
  .fade-up-delay-4 { transition-delay: 0.6s; }

  /* Cover parallax */
  .cover-image {
    transition: transform 0.1s linear;
    will-change: transform;
  }

  /* Elegant underline input */
  .editorial-input {
    background: transparent;
    border: none;
    border-bottom: 1px solid rgba(26,26,26,0.2);
    outline: none;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 18px;
    font-weight: 300;
    color: #1A1A1A;
    padding: 12px 0;
    width: 100%;
    transition: border-color 0.3s ease;
  }
  .editorial-input:focus {
    border-bottom-color: #FF8200;
  }
  .editorial-input::placeholder {
    color: rgba(26,26,26,0.3);
    font-weight: 300;
  }

  /* Field reveal */
  .field-group {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    max-height: 0;
    overflow: hidden;
    margin-bottom: 0;
  }
  .field-group.active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
    max-height: 120px;
    margin-bottom: 32px;
  }

  /* Quiz option tiles */
  .quiz-tile {
    border: 1px solid rgba(26,26,26,0.1);
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }
  .quiz-tile:hover {
    border-color: rgba(26,26,26,0.25);
  }
  .quiz-tile.selected {
    border-color: #FF8200;
  }
  .quiz-tile.selected::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20%;
    right: 20%;
    height: 2px;
    background: #FF8200;
  }

  /* Dual-range slider */
  .range-slider-wrap {
    position: relative;
    height: 40px;
    margin: 30px 0 16px;
  }
  .range-slider-wrap input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    position: absolute;
    left: 0; top: 0;
    width: 100%;
    height: 40px;
    background: transparent;
    pointer-events: none;
    outline: none;
    margin: 0;
  }
  .range-slider-wrap input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #FF8200;
    cursor: pointer;
    pointer-events: all;
    border: 3px solid #FAF8F5;
    box-shadow: 0 2px 8px rgba(255,130,0,0.35);
    transition: transform 0.2s ease;
    position: relative;
    z-index: 2;
  }
  .range-slider-wrap input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }
  .range-slider-wrap input[type="range"]::-webkit-slider-runnable-track {
    height: 2px;
    background: transparent;
  }
  .range-track {
    position: absolute;
    top: 50%; left: 0; right: 0;
    height: 2px;
    background: rgba(26,26,26,0.12);
    transform: translateY(-50%);
    border-radius: 1px;
    pointer-events: none;
  }
  .range-track-fill {
    position: absolute;
    top: 50%;
    height: 2px;
    background: #FF8200;
    transform: translateY(-50%);
    border-radius: 1px;
    pointer-events: none;
  }
  .budget-inputs {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-top: 8px;
  }
  .budget-input-field {
    width: 90px;
    padding: 8px 12px;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: #1A1A1A;
    text-align: center;
    border: 1px solid rgba(26,26,26,0.12);
    border-radius: 8px;
    background: white;
    outline: none;
    transition: border-color 0.2s ease;
  }
  .budget-input-field:focus {
    border-color: #FF8200;
  }

  /* Custom checkbox */
  .amenity-check {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 0;
    cursor: pointer;
    border-bottom: 1px solid rgba(26,26,26,0.05);
    transition: all 0.2s ease;
  }
  .amenity-check:hover { padding-left: 4px; }
  .check-box {
    width: 20px;
    height: 20px;
    border: 1.5px solid rgba(26,26,26,0.2);
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s ease;
    flex-shrink: 0;
  }
  .amenity-check.checked .check-box {
    background: #FF8200;
    border-color: #FF8200;
  }
  .check-icon {
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s ease;
  }
  .amenity-check.checked .check-icon {
    opacity: 1;
    transform: scale(1);
  }

  /* Distance option */
  .distance-opt {
    flex: 1;
    text-align: center;
    padding: 28px 12px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
  }
  .distance-opt::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 30%;
    right: 30%;
    height: 2px;
    background: #FF8200;
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }
  .distance-opt.selected::after { transform: scaleX(1); }
  .distance-opt.selected .dist-label { color: #FF8200; }

  /* Priority ranking */
  .priority-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 18px 0;
    border-bottom: 1px solid rgba(26,26,26,0.06);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .priority-item:hover { padding-left: 6px; }
  .priority-num {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Playfair Display', serif;
    font-size: 14px;
    border: 1px solid rgba(26,26,26,0.15);
    transition: all 0.3s ease;
    flex-shrink: 0;
  }
  .priority-item.ranked .priority-num {
    background: #FF8200;
    border-color: #FF8200;
    color: white;
  }

  /* Result card */
  .result-hero {
    position: relative;
    overflow: hidden;
  }
  .result-hero img {
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .result-hero:hover img {
    transform: scale(1.03);
  }

  /* Swipeable result cards (v3-style, v1 aesthetic) */
  #card-stack-container { min-height: 360px; position: relative; }
  #card-stack { position: relative; width: 100%; height: 100%; min-height: 360px; }
  .result-apt-card {
    position: absolute; width: 100%; height: 100%; border-radius: 12px; overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    cursor: grab; user-select: none;
  }
  .result-apt-card:active { cursor: grabbing; }
  .result-apt-card .card-image { width: 100%; height: 55%; object-fit: cover; }
  .result-apt-card .card-content {
    position: absolute; bottom: 0; left: 0; right: 0; background: white;
    border-radius: 12px 12px 0 0; padding: 24px 28px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.06);
  }
  .card-nav-btn {
    width: 52px; height: 52px; border-radius: 50%; background: white;
    border: 1px solid rgba(26,26,26,0.1); box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    transition: all 0.2s ease;
  }
  .card-nav-btn:hover { background: #FF8200; color: white; border-color: #FF8200; }
  .card-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .card-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(26,26,26,0.2); transition: all 0.3s; }
  .card-dot.active { background: #FF8200; width: 24px; }

  /* Unified button system - editorial aesthetic */
  .btn {
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .btn-primary {
    background: #FF8200;
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: 8px;
    font-size: 13px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .btn-primary:hover { background: #E67500; box-shadow: 0 4px 16px rgba(255,130,0,0.35); }
  .btn-primary:active { transform: scale(0.98); }
  .btn-secondary {
    background: transparent;
    color: rgba(26,26,26,0.6);
    border: 1px solid rgba(26,26,26,0.15);
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .btn-secondary:hover { border-color: #FF8200; color: #FF8200; background: rgba(255,130,0,0.06); }
  .btn-ghost {
    background: transparent;
    border: none;
    color: rgba(26,26,26,0.5);
    padding: 8px 0;
    font-size: 12px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .btn-ghost:hover { color: #FF8200; }
  .btn-nav {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: white;
    border: 1px solid rgba(26,26,26,0.1);
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .btn-nav:hover { background: #FF8200; color: white; border-color: #FF8200; }
  .btn-nav:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn-icon-round {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid rgba(26,26,26,0.15);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .btn-icon-round:hover { border-color: #FF8200; color: #FF8200; }
  .btn-icon-round.primary { background: #FF8200; border-color: #FF8200; color: white; }
  .btn-icon-round.primary:hover { background: #E67500; border-color: #E67500; }
  .btn-link {
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 12px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 8px 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .btn-link:hover { color: white; }

  /* Leaflet overrides */
  .campus-tooltip { font-family: 'Space Grotesk', sans-serif; font-size: 10px; color: rgba(26,26,26,0.5); background: rgba(255,255,255,0.85); border: none; box-shadow: none; }
  .leaflet-popup-content-wrapper { border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
  /* Roommate tag */
  .rm-tag { font-family: 'Space Grotesk', sans-serif; }
  .rm-tag.selected { background: #FF8200 !important; color: white !important; border-color: #FF8200 !important; }

  /* Alert toggle */
  .alert-toggle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid rgba(26,26,26,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: transparent;
  }
  .alert-toggle.active {
    background: #FF8200;
    border-color: #FF8200;
  }
  .alert-toggle.active svg { color: white; }

  /* Bottom nav pill */
  #bottom-nav {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(75,75,75,0.92);
    overflow-x: auto;
    overflow-y: hidden;
    max-width: 430px;
    -webkit-overflow-scrolling: touch;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 28px;
    padding: 10px 16px;
    display: flex;
    gap: 12px;
    z-index: 200;
    opacity: 0;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255,255,255,0.08);
  }
  #bottom-nav.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
  .nav-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 12px;
    transition: all 0.25s ease;
    color: rgba(255,255,255,0.5);
  }
  .nav-icon:hover { color: rgba(255,255,255,0.8); }
  .nav-icon.active {
    color: #FF8200;
    background: rgba(255,130,0,0.15);
  }
  .nav-icon { flex-direction: column; gap: 2px; padding: 8px 10px; min-width: 48px; height: auto; }
  .nav-icon svg { flex-shrink: 0; }
  .nav-label { font-size: 9px; font-family: 'Space Grotesk', sans-serif; }

  /* Overlay screens */
  .overlay-screen {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 430px;
    height: 100vh;
    background: #FAF8F5;
    z-index: 150;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    overflow-y: auto;
    padding: 60px 36px 120px;
  }
  .overlay-screen.visible {
    opacity: 1;
    pointer-events: all;
  }

  .detail-carousel {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    gap: 0;
  }
  .detail-carousel::-webkit-scrollbar { display: none; }
  .detail-carousel img {
    flex: 0 0 100%;
    width: 100%;
    height: 240px;
    object-fit: cover;
    scroll-snap-align: start;
  }
  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 6px;
    padding: 10px 0 4px;
  }
  .carousel-dots .dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: rgba(26,26,26,0.15);
    transition: background 0.3s;
  }
  .carousel-dots .dot.active {
    background: #FF8200;
  }
  .detail-plan-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(26,26,26,0.06);
  }
  .detail-plan-row.sold-out {
    opacity: 0.4;
    text-decoration: line-through;
  }
  .detail-plan-row.matched {
    background: rgba(255,130,0,0.06);
    margin: 0 -16px;
    padding: 10px 16px;
    border-radius: 6px;
  }

  /* Scroll reveal observer */
  .reveal {
    opacity: 0;
    transform: translateY(24px);
    transition: opacity 0.7s ease, transform 0.7s ease;
  }
  .reveal.in-view {
    opacity: 1;
    transform: translateY(0);
  }

  /* Page turn divider */
  .editorial-divider {
    width: 40px;
    height: 1px;
    background: rgba(26,26,26,0.2);
    margin: 0 auto;
  }

  /* Keyframes */
  @keyframes float-arrow {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(6px); }
  }
  .float-arrow { animation: float-arrow 2s ease-in-out infinite; }

  @keyframes fade-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes subtle-zoom {
    from { transform: scale(1); }
    to { transform: scale(1.08); }
  }
  .subtle-zoom {
    animation: subtle-zoom 20s ease-in-out alternate infinite;
  }

  /* Roommate pulse ring animation */
  .rm-pulse-ring {
    width:40px; height:40px; border-radius:50%;
    border:2px solid rgba(255,130,0,0.3);
    animation: rm-pulse 2s ease-out infinite;
  }
  @keyframes rm-pulse {
    0% { transform:scale(0.8); opacity:1; }
    100% { transform:scale(1.8); opacity:0; }
  }

  /* Roommate Tinder-style matching */
  .rm-tab-bar {
    display:flex; gap:0; margin-bottom:20px; border-bottom:1px solid rgba(26,26,26,0.08);
  }
  .rm-tab-bar button {
    flex:1; padding:12px 0; background:none; border:none; font-family:'Libre Baskerville',serif;
    font-size:14px; color:rgba(26,26,26,0.35); cursor:pointer; position:relative; transition:color 0.3s;
  }
  .rm-tab-bar button.active {
    color:#1A1A1A; font-weight:600;
  }
  .rm-tab-bar button.active::after {
    content:''; position:absolute; bottom:-1px; left:20%; right:20%; height:2px; background:#FF8200; border-radius:1px;
  }
  .rm-filter-bar {
    display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; margin-bottom:20px;
    scrollbar-width:none; -webkit-overflow-scrolling:touch;
  }
  .rm-filter-bar::-webkit-scrollbar { display:none; }
  .rm-filter-pill {
    flex-shrink:0; padding:7px 16px; border-radius:20px; border:1px solid rgba(26,26,26,0.1);
    font-family:'DM Sans',sans-serif; font-size:12px; color:rgba(26,26,26,0.5);
    background:transparent; cursor:pointer; transition:all 0.25s; white-space:nowrap;
  }
  .rm-filter-pill.active {
    background:#FF8200; color:white; border-color:#FF8200;
  }
  .rm-card-stack {
    position:relative; height:420px; margin-bottom:20px;
  }
  .rm-card {
    position:absolute; top:0; left:0; right:0; height:100%;
    background:white; border-radius:16px; overflow:hidden;
    box-shadow:0 4px 24px rgba(0,0,0,0.08); border:1px solid rgba(26,26,26,0.06);
    touch-action:none; cursor:grab; transition:box-shadow 0.3s;
    display:flex; flex-direction:column;
  }
  .rm-card:active { cursor:grabbing; }
  .rm-card.behind {
    transform:scale(0.95) translateY(10px);
    opacity:0.5; pointer-events:none;
  }
  .rm-card.far-behind {
    transform:scale(0.90) translateY(20px);
    opacity:0.25; pointer-events:none;
  }
  .rm-card-header {
    display:flex; align-items:center; gap:16px; padding:20px 24px 16px;
  }
  .rm-avatar {
    width:52px; height:52px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    flex-shrink:0;
  }
  .rm-avatar span { font-family:'Libre Baskerville',serif; color:white; font-size:20px; font-weight:600; }
  .rm-compat-badge {
    position:absolute; top:16px; right:20px; width:48px; height:48px; border-radius:50%;
    border:3px solid #FF8200; display:flex; align-items:center; justify-content:center;
    font-family:'DM Sans',sans-serif; font-size:13px; font-weight:700; color:#FF8200;
  }
  .rm-card-body {
    flex:1; overflow-y:auto; padding:0 24px 20px;
  }
  .rm-trait-row {
    display:flex; justify-content:space-between; padding:7px 0;
    border-bottom:1px solid rgba(26,26,26,0.04);
    font-family:'DM Sans',sans-serif; font-size:13px;
  }
  .rm-trait-row .label { color:rgba(26,26,26,0.4); }
  .rm-trait-row .value { color:#1A1A1A; font-weight:500; }
  .rm-card-tags {
    display:flex; flex-wrap:wrap; gap:6px; margin-top:12px;
  }
  .rm-card-tags span {
    font-family:'DM Sans',sans-serif; font-size:11px; padding:4px 12px;
    border-radius:20px; background:rgba(255,130,0,0.08); color:#FF8200;
  }
  .rm-swipe-btns {
    display:flex; justify-content:center; gap:32px; margin-bottom:20px;
  }
  .rm-swipe-btn {
    width:60px; height:60px; border-radius:50%; border:2px solid; display:flex;
    align-items:center; justify-content:center; cursor:pointer; background:white;
    transition:transform 0.2s, box-shadow 0.2s;
  }
  .rm-swipe-btn:hover { transform:scale(1.1); }
  .rm-swipe-btn:active { transform:scale(0.95); }
  .rm-swipe-btn.pass { border-color:#FF4458; }
  .rm-swipe-btn.pass svg { stroke:#FF4458; }
  .rm-swipe-btn.match { border-color:#4CD964; }
  .rm-swipe-btn.match svg { stroke:#4CD964; }

  .rm-match-flash {
    position:fixed; top:0; left:0; right:0; bottom:0; z-index:9999;
    background:rgba(0,0,0,0.6); display:flex; flex-direction:column;
    align-items:center; justify-content:center; opacity:0; pointer-events:none;
    transition:opacity 0.3s;
  }
  .rm-match-flash.show { opacity:1; pointer-events:all; }
  .rm-match-flash h2 {
    font-family:'Libre Baskerville',serif; font-size:36px; color:white;
    margin-bottom:8px; animation:matchPop 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
  }
  .rm-match-flash p { font-family:'DM Sans',sans-serif; font-size:15px; color:rgba(255,255,255,0.7); }
  @keyframes matchPop {
    0% { transform:scale(0.3); opacity:0; }
    100% { transform:scale(1); opacity:1; }
  }
  @keyframes rmFlyLeft {
    to { transform:translateX(-150%) rotate(-20deg); opacity:0; }
  }
  @keyframes rmFlyRight {
    to { transform:translateX(150%) rotate(20deg); opacity:0; }
  }

  .rm-match-card {
    border:1px solid rgba(26,26,26,0.08); border-radius:12px; padding:16px 20px;
    margin-bottom:12px; background:white;
  }
  .rm-match-card-header {
    display:flex; align-items:center; gap:12px; margin-bottom:12px;
  }
  .rm-match-avatar {
    width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0;
  }
  .rm-match-avatar span { font-family:'Libre Baskerville',serif; color:white; font-size:14px; font-weight:600; }
  .rm-match-info { flex:1; }
  .rm-match-actions {
    display:flex; gap:10px; margin-top:12px; padding-top:12px; border-top:1px solid rgba(26,26,26,0.06);
  }
  .rm-empty-state {
    text-align:center; padding:48px 24px;
    border:1px dashed rgba(26,26,26,0.12); border-radius:16px;
    background:linear-gradient(180deg, #f0ede8 0%, #e8e4df 100%);
  }

  /* Lease analysis spinner */
  .lease-spinner {
    width: 32px; height: 32px; border: 3px solid rgba(255,130,0,0.15);
    border-top-color: #FF8200; border-radius: 50%; margin: 0 auto;
    animation: lease-spin 0.8s linear infinite;
  }
  @keyframes lease-spin { to { transform: rotate(360deg); } }

  /* Star rating */
  .star { color: #FF8200; }

  /* Transition between main sections */
  .main-section {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .main-section.active {
    display: block;
    opacity: 1;
  }

  /* Quiz question transitions */
  .quiz-question {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .quiz-question.active {
    display: block;
    opacity: 1;
  }
</style>
</head>
<body>

<!-- Progress Bar -->
<div id="progress-bar"><div id="progress-fill"></div></div>

<!-- Phone Frame -->
<div id="phone-frame">
<div id="app-scroll">

<!-- ============================================ -->
<!-- SECTION 1: THE COVER                         -->
<!-- ============================================ -->
<section id="section-cover" class="main-section active section-screen" style="height:100vh; position:relative; overflow:hidden;">
  <!-- Hero Image: Ayres Hall, UT Knoxville -->
  <div style="position:absolute; inset:0; overflow:hidden;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/8a/Ayres_Hall_at_UT_Knoxville.jpg" 
         alt="Ayres Hall, University of Tennessee Knoxville" 
         class="cover-image subtle-zoom"
         style="width:100%; height:100%; object-fit:cover; object-position:center 30%; filter:brightness(0.5) contrast(1.05) saturate(1.1);">
  </div>

  <!-- Overlay Content -->
  <div style="position:absolute; inset:0; display:flex; flex-direction:column; justify-content:space-between; padding:60px 36px 48px;">
    
    <!-- Top: Issue marker -->
    <div class="fade-up" style="animation: fade-in-up 1s ease 0.2s both;">
      <p class="font-body text-white/40" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase;">Go Vols · Student Housing Near the Hill</p>
    </div>

    <!-- Center: Title -->
    <div style="margin-top:-40px;">
      <h1 class="font-editorial text-white fade-up" style="font-size:76px; line-height:0.9; font-weight:400; animation: fade-in-up 1s ease 0.5s both;">
        SMART<br><span style="color:#FF8200;">LEASE</span>
      </h1>
      <div style="width:40px; height:2px; background:#FF8200; margin:24px 0; animation: fade-in-up 1s ease 0.8s both;"></div>
      <p class="font-body text-white/70 small-caps fade-up" style="font-size:14px; animation: fade-in-up 1s ease 1s both;">
        find your place in Rocky Top.
      </p>
    </div>

    <!-- Bottom: Begin -->
    <div style="text-align:center; animation: fade-in-up 1s ease 1.4s both;">
      <button onclick="goToSection('section-story')" class="btn btn-link" style="color:rgba(255,255,255,0.6);">
        <p class="font-body" style="font-size:12px; letter-spacing:0.15em; text-transform:uppercase; margin-bottom:8px;">Begin</p>
        <div class="float-arrow">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 5v14M5 12l7 7 7-7"/>
          </svg>
        </div>
      </button>
    </div>
  </div>
</section>

<!-- ============================================ -->
<!-- SECTION 2: THE STORY (Onboarding)            -->
<!-- ============================================ -->
<section id="section-story" class="main-section section-screen" style="min-height:100vh; background:#FAF8F5; display:none; flex-direction:column; padding:80px 36px 48px;">
  
  <div>
    <p class="font-body" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:rgba(26,26,26,0.35); margin-bottom:48px;">Welcome, Vol</p>
    
    <h2 class="font-editorial" style="font-size:44px; line-height:1.1; color:#1A1A1A; font-weight:400; margin-bottom:12px;">
      Let's get to<br>know you.
    </h2>
    <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.45); font-weight:300; margin-bottom:56px;">
      A few details to find your perfect place near the Hill.
    </p>

    <!-- Form Fields (reveal one at a time) -->
    <div id="onboarding-form">
      <div class="field-group active" id="field-1">
        <label class="font-body" style="font-size:11px; letter-spacing:0.12em; text-transform:uppercase; color:rgba(26,26,26,0.4);">First Name</label>
        <input type="text" class="editorial-input" id="input-first" placeholder="Your first name" oninput="checkFieldProgress(1)">
      </div>

      <div class="field-group" id="field-2">
        <label class="font-body" style="font-size:11px; letter-spacing:0.12em; text-transform:uppercase; color:rgba(26,26,26,0.4);">Last Name</label>
        <input type="text" class="editorial-input" id="input-last" placeholder="Your last name" oninput="checkFieldProgress(2)">
      </div>

      <div class="field-group" id="field-3">
        <label class="font-body" style="font-size:11px; letter-spacing:0.12em; text-transform:uppercase; color:rgba(26,26,26,0.4);">Email</label>
        <input type="email" class="editorial-input" id="input-email" placeholder="netid@vols.utk.edu" oninput="checkFieldProgress(3)">
      </div>

      <div class="field-group" id="field-4">
        <label class="font-body" style="font-size:11px; letter-spacing:0.12em; text-transform:uppercase; color:rgba(26,26,26,0.4);">Phone</label>
        <input type="tel" class="editorial-input" id="input-phone" placeholder="(865) XXX-XXXX" oninput="checkFieldProgress(4)">
      </div>
    </div>
  </div>

  <!-- Continue Button -->
  <div style="margin-top:auto; padding-top:40px;">
    <button id="story-continue" onclick="saveUserInfo(); goToSection('section-quiz')" class="btn btn-ghost"
            style="opacity:0.25; pointer-events:none; transition:all 0.4s ease; display:flex; align-items:center; gap:12px; color:#1A1A1A;">
      <span class="font-body" style="font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:#1A1A1A;">Continue</span>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF8200" stroke-width="1.5">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</section>

<!-- ============================================ -->
<!-- SECTION 3: THE QUIZ                          -->
<!-- ============================================ -->
<section id="section-quiz" class="main-section section-screen" style="min-height:100vh; background:#FAF8F5; display:none; flex-direction:column;">

  <!-- Q1: BEDROOMS -->
  <div class="quiz-question active" id="quiz-q1" style="padding:80px 36px 48px; min-height:100vh; display:flex; flex-direction:column;">
    <p class="font-body" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:rgba(26,26,26,0.35); margin-bottom:48px;">01 / 05</p>
    
    <h2 class="font-editorial" style="font-size:38px; line-height:1.1; color:#1A1A1A; font-weight:400; margin-bottom:48px;">
      How much<br>space do<br>you need?
    </h2>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:auto;">
      <div class="quiz-tile" onclick="selectBedroom(this, 'Studio')" style="padding:22px 16px; border-radius:8px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.3); margin-bottom:10px;">
          <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="12" x2="21" y2="12"/>
        </svg>
        <p class="font-editorial" style="font-size:18px; color:#1A1A1A;">Studio</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.4); margin-top:2px;">Open concept</p>
      </div>
      <div class="quiz-tile" onclick="selectBedroom(this, '1 Bed')" style="padding:22px 16px; border-radius:8px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.3); margin-bottom:10px;">
          <rect x="2" y="4" width="20" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/>
        </svg>
        <p class="font-editorial" style="font-size:18px; color:#1A1A1A;">1 Bed</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.4); margin-top:2px;">Your own room</p>
      </div>
      <div class="quiz-tile" onclick="selectBedroom(this, '2 Bed')" style="padding:22px 16px; border-radius:8px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.3); margin-bottom:10px;">
          <rect x="2" y="4" width="20" height="16" rx="2"/><line x1="9" y1="4" x2="9" y2="20"/><line x1="15" y1="4" x2="15" y2="20"/>
        </svg>
        <p class="font-editorial" style="font-size:18px; color:#1A1A1A;">2 Bed</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.4); margin-top:2px;">Share the space</p>
      </div>
      <div class="quiz-tile" onclick="selectBedroom(this, '3 Bed')" style="padding:22px 16px; border-radius:8px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.3); margin-bottom:10px;">
          <rect x="1" y="4" width="22" height="16" rx="2"/><line x1="8" y1="4" x2="8" y2="20"/><line x1="16" y1="4" x2="16" y2="20"/>
        </svg>
        <p class="font-editorial" style="font-size:18px; color:#1A1A1A;">3 Bed</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.4); margin-top:2px;">Triple up</p>
      </div>
      <div class="quiz-tile" onclick="selectBedroom(this, '4 Bed')" style="padding:22px 16px; border-radius:8px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.3); margin-bottom:10px;">
          <rect x="1" y="4" width="22" height="16" rx="2"/><line x1="6" y1="4" x2="6" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="18" y1="4" x2="18" y2="20"/>
        </svg>
        <p class="font-editorial" style="font-size:18px; color:#1A1A1A;">4 Bed</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.4); margin-top:2px;">Squad up</p>
      </div>
      <div class="quiz-tile" onclick="selectBedroom(this, '5 Bed')" style="padding:22px 16px; border-radius:8px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.3); margin-bottom:10px;">
          <rect x="1" y="4" width="22" height="16" rx="2"/><line x1="5" y1="4" x2="5" y2="20"/><line x1="9.5" y1="4" x2="9.5" y2="20"/><line x1="14.5" y1="4" x2="14.5" y2="20"/><line x1="19" y1="4" x2="19" y2="20"/>
        </svg>
        <p class="font-editorial" style="font-size:18px; color:#1A1A1A;">5 Bed</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.4); margin-top:2px;">Room for everyone</p>
      </div>
    </div>

    <div style="padding-top:32px;">
      <button id="q1-next" onclick="nextQuestion(2)" class="btn btn-ghost"
              style="opacity:0.2; pointer-events:none; transition:all 0.4s ease; display:flex; align-items:center; gap:12px; color:#1A1A1A;">
        <span class="font-body" style="font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:#1A1A1A;">Next</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF8200" stroke-width="1.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <!-- Q2: BUDGET -->
  <div class="quiz-question" id="quiz-q2" style="padding:80px 36px 48px; min-height:100vh; display:none; flex-direction:column;">
    <p class="font-body" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:rgba(26,26,26,0.35); margin-bottom:48px;">02 / 05</p>
    
    <h2 class="font-editorial" style="font-size:38px; line-height:1.1; color:#1A1A1A; font-weight:400; margin-bottom:20px;">
      What's<br>comfortable?
    </h2>
    <p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.4); font-weight:300; margin-bottom:60px;">Monthly budget, all-in.</p>

    <div style="text-align:center; margin-bottom:20px;">
      <span class="font-editorial" id="budget-display" style="font-size:56px; color:#1A1A1A; font-weight:400; line-height:1;">$700 — $1,400</span>
      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.35); margin-top:8px;">per month</p>
    </div>

    <div style="padding:0 8px; margin-bottom:auto;">
      <div class="range-slider-wrap">
        <div class="range-track"></div>
        <div class="range-track-fill" id="range-fill"></div>
        <input type="range" min="500" max="2500" value="700" step="50" id="budget-min" oninput="updateBudgetRange()">
        <input type="range" min="500" max="2500" value="1400" step="50" id="budget-max" oninput="updateBudgetRange()">
      </div>
      <div style="display:flex; justify-content:space-between;">
        <span class="font-body" style="font-size:11px; color:rgba(26,26,26,0.3);">$500</span>
        <span class="font-body" style="font-size:11px; color:rgba(26,26,26,0.3);">$2,500</span>
      </div>
      <div class="budget-inputs">
        <div>
          <label class="font-body" style="font-size:10px; letter-spacing:0.1em; text-transform:uppercase; color:rgba(26,26,26,0.35); display:block; margin-bottom:4px; text-align:center;">Min</label>
          <input type="text" class="budget-input-field" id="budget-min-input" value="$700" onchange="updateBudgetFromInput()">
        </div>
        <span class="font-body" style="font-size:16px; color:rgba(26,26,26,0.2);">—</span>
        <div>
          <label class="font-body" style="font-size:10px; letter-spacing:0.1em; text-transform:uppercase; color:rgba(26,26,26,0.35); display:block; margin-bottom:4px; text-align:center;">Max</label>
          <input type="text" class="budget-input-field" id="budget-max-input" value="$1,400" onchange="updateBudgetFromInput()">
        </div>
      </div>
    </div>

    <div style="padding-top:32px; display:flex; gap:16px;">
      <button onclick="prevQuestion(1)" class="btn btn-ghost" style="display:flex; align-items:center; gap:8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        <span class="font-body" style="font-size:12px; text-transform:uppercase; letter-spacing:0.1em;">Back</span>
      </button>
      <button onclick="nextQuestion(3)" class="btn btn-ghost" style="display:flex; align-items:center; gap:12px; color:#1A1A1A;">
        <span class="font-body" style="font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:#1A1A1A;">Next</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF8200" stroke-width="1.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <!-- Q3: AMENITIES -->
  <div class="quiz-question" id="quiz-q3" style="padding:80px 36px 48px; min-height:100vh; display:none; flex-direction:column;">
    <p class="font-body" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:rgba(26,26,26,0.35); margin-bottom:48px;">03 / 05</p>
    
    <h2 class="font-editorial" style="font-size:38px; line-height:1.1; color:#1A1A1A; font-weight:400; margin-bottom:40px;">
      The<br>essentials.
    </h2>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0 24px; margin-bottom:auto;">
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Pool">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Pool</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">Beat the heat</p>
        </div>
      </div>
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Gym">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Gym</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">Stay active</p>
        </div>
      </div>
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Parking">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Parking</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">Covered spots</p>
        </div>
      </div>
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Furnished">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Furnished</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">Move-in ready</p>
        </div>
      </div>
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Pet Friendly">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Pet Friendly</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">Bring your buddy</p>
        </div>
      </div>
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Study Room">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Study Room</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">Quiet focus</p>
        </div>
      </div>
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Laundry">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Laundry</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">In-unit W/D</p>
        </div>
      </div>
      <div class="amenity-check" onclick="toggleAmenity(this)" data-amenity="Game Room">
        <div class="check-box"><svg class="check-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div>
          <p class="font-body" style="font-size:14px; color:#1A1A1A;">Game Room</p>
          <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35);">Unwind & play</p>
        </div>
      </div>
    </div>

    <div style="padding-top:32px; display:flex; gap:16px;">
      <button onclick="prevQuestion(2)" class="btn btn-ghost" style="display:flex; align-items:center; gap:8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        <span class="font-body" style="font-size:12px; text-transform:uppercase; letter-spacing:0.1em;">Back</span>
      </button>
      <button onclick="nextQuestion(4)" class="btn btn-ghost" style="display:flex; align-items:center; gap:12px; color:#1A1A1A;">
        <span class="font-body" style="font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:#1A1A1A;">Next</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF8200" stroke-width="1.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <!-- Q4: DISTANCE -->
  <div class="quiz-question" id="quiz-q4" style="padding:80px 36px 48px; min-height:100vh; display:none; flex-direction:column;">
    <p class="font-body" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:rgba(26,26,26,0.35); margin-bottom:48px;">04 / 05</p>
    
    <h2 class="font-editorial" style="font-size:38px; line-height:1.1; color:#1A1A1A; font-weight:400; margin-bottom:56px;">
      How close to<br>campus?
    </h2>

    <div style="display:flex; border-top:1px solid rgba(26,26,26,0.08); border-bottom:1px solid rgba(26,26,26,0.08); margin-bottom:auto;">
      <div class="distance-opt" onclick="selectDistance(this, 'walking')">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.25); margin:0 auto 14px; display:block;">
          <circle cx="12" cy="5" r="2"/><path d="M10 22l2-7 3 3v6M14 13l2-3-3-3-3 4"/>
        </svg>
        <p class="font-editorial dist-label" style="font-size:18px; color:#1A1A1A; transition:color 0.3s;">Walking</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35); margin-top:4px;">&lt; 10 min</p>
      </div>
      <div style="width:1px; background:rgba(26,26,26,0.08);"></div>
      <div class="distance-opt" onclick="selectDistance(this, 'biking')">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.25); margin:0 auto 14px; display:block;">
          <circle cx="5.5" cy="17.5" r="3.5"/><circle cx="18.5" cy="17.5" r="3.5"/><path d="M15 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-3 11.5V14l-3-3 4-3 2 3h2"/>
        </svg>
        <p class="font-editorial dist-label" style="font-size:18px; color:#1A1A1A; transition:color 0.3s;">Biking</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35); margin-top:4px;">10–20 min</p>
      </div>
      <div style="width:1px; background:rgba(26,26,26,0.08);"></div>
      <div class="distance-opt" onclick="selectDistance(this, 'driving')">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color:rgba(26,26,26,0.25); margin:0 auto 14px; display:block;">
          <path d="M5 17h14v-5l-2-5H7L5 12z"/><circle cx="7.5" cy="17.5" r="1.5"/><circle cx="16.5" cy="17.5" r="1.5"/>
        </svg>
        <p class="font-editorial dist-label" style="font-size:18px; color:#1A1A1A; transition:color 0.3s;">Driving</p>
        <p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35); margin-top:4px;">No limit</p>
      </div>
    </div>

    <div style="padding-top:32px; display:flex; gap:16px;">
      <button onclick="prevQuestion(3)" class="btn btn-ghost" style="display:flex; align-items:center; gap:8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        <span class="font-body" style="font-size:12px; text-transform:uppercase; letter-spacing:0.1em;">Back</span>
      </button>
      <button id="q4-next" onclick="nextQuestion(5)" class="btn btn-ghost" style="opacity:0.2; pointer-events:none; transition:all 0.4s ease; display:flex; align-items:center; gap:12px; color:#1A1A1A;">
        <span class="font-body" style="font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:#1A1A1A;">Next</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF8200" stroke-width="1.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <!-- Q5: PRIORITY -->
  <div class="quiz-question" id="quiz-q5" style="padding:80px 36px 48px; min-height:100vh; display:none; flex-direction:column;">
    <p class="font-body" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:rgba(26,26,26,0.35); margin-bottom:48px;">05 / 05</p>
    
    <h2 class="font-editorial" style="font-size:38px; line-height:1.1; color:#1A1A1A; font-weight:400; margin-bottom:16px;">
      What matters<br>most?
    </h2>
    <p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.4); font-weight:300; margin-bottom:40px;">Tap to rank in order of importance.</p>

    <div id="priority-list" style="margin-bottom:auto;">
      <div class="priority-item" onclick="rankPriority(this)" data-label="Price">
        <div class="priority-num">—</div>
        <div>
          <p class="font-body" style="font-size:16px; color:#1A1A1A;">Price</p>
          <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.35);">Staying within budget</p>
        </div>
      </div>
      <div class="priority-item" onclick="rankPriority(this)" data-label="Location">
        <div class="priority-num">—</div>
        <div>
          <p class="font-body" style="font-size:16px; color:#1A1A1A;">Location</p>
          <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.35);">Steps from the Hill</p>
        </div>
      </div>
      <div class="priority-item" onclick="rankPriority(this)" data-label="Amenities">
        <div class="priority-num">—</div>
        <div>
          <p class="font-body" style="font-size:16px; color:#1A1A1A;">Amenities</p>
          <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.35);">Must-have features</p>
        </div>
      </div>
      <div class="priority-item" onclick="rankPriority(this)" data-label="Reviews">
        <div class="priority-num">—</div>
        <div>
          <p class="font-body" style="font-size:16px; color:#1A1A1A;">Reviews</p>
          <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.35);">What others say</p>
        </div>
      </div>
    </div>

    <div style="padding-top:32px; display:flex; gap:16px;">
      <button onclick="prevQuestion(4)" class="btn btn-ghost" style="display:flex; align-items:center; gap:8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        <span class="font-body" style="font-size:12px; text-transform:uppercase; letter-spacing:0.1em;">Back</span>
      </button>
      <button id="q5-finish" onclick="showResults()" class="btn btn-ghost" style="opacity:0.2; pointer-events:none; transition:all 0.4s ease; display:flex; align-items:center; gap:12px; color:#1A1A1A;">
        <span class="font-body" style="font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:#1A1A1A;">See Results</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF8200" stroke-width="1.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

</section>

<!-- ============================================ -->
<!-- SECTION 4: THE RESULTS (Swipeable Cards)     -->
<!-- ============================================ -->
<section id="section-results" class="main-section section-screen" style="background:#FAF8F5; display:none; flex-direction:column; padding-bottom:120px; min-height:100vh;">

  <!-- Results Header -->
  <div style="padding:60px 36px 24px;">
    <p class="font-body" style="font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:rgba(26,26,26,0.35); margin-bottom:16px;">Go Vols · VFL</p>
    <h2 class="font-editorial" style="font-size:36px; line-height:1.05; color:#1A1A1A; font-weight:400;">
      Your curated<br>selection.
    </h2>
    <p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.4); font-weight:300; margin-top:8px;">
      Swipe to explore · Apartments near the Hill
    </p>
    <div style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap;">
      <button onclick="retakeSurvey()" class="btn btn-secondary" style="font-size:11px; padding:10px 20px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block; vertical-align:-2px; margin-right:6px;"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>Retake Survey
      </button>
      <button id="btn-favorites-filter" onclick="toggleFavoritesView()" class="btn btn-secondary" style="font-size:11px; padding:10px 20px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:inline-block; vertical-align:-2px; margin-right:6px;"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>Favorites
      </button>
    </div>
  </div>

  <!-- Card stack (v3-style matches) -->
  <div id="card-stack-container" style="flex:1; padding:0 24px; min-height:380px;">
    <div id="card-stack" style="height:100%;">
      <!-- Cards injected by renderResults() -->
    </div>
    <div id="swipe-hint" style="position:absolute; bottom:16px; left:0; right:0; text-align:center;">
      <span class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35); letter-spacing:0.08em;">Swipe or use arrows</span>
    </div>
  </div>

  <!-- Card navigation -->
  <div style="display:flex; align-items:center; justify-content:center; gap:24px; padding:24px 36px;">
    <button type="button" onclick="prevResultCard()" id="btn-prev-card" class="btn card-nav-btn" disabled>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    </button>
    <div id="card-dots" style="display:flex; gap:8px; align-items:center;"></div>
    <button type="button" onclick="nextResultCard()" id="btn-next-card" class="btn card-nav-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
    </button>
  </div>

  <!-- Colophon -->
  <div id="results-colophon" style="padding:0 36px 220px; text-align:center;">
    <div class="editorial-divider" style="margin-bottom:32px;"></div>
      <p class="font-editorial" style="font-size:20px; font-style:italic;"><span style="color:rgba(26,26,26,0.35);">Smart</span><span style="color:#FF8200;">Lease</span></p>
      <p class="font-body" style="font-size:9px; color:rgba(26,26,26,0.15); margin-top:8px;">Cover: Ayres Hall © Bubbahotepblues / Wikimedia Commons (CC BY-SA 4.0)</p>
  </div>

</section>

</div><!-- end app-scroll -->
</div><!-- end phone-frame -->

<!-- Bottom Navigation Pill -->
<nav id="bottom-nav">
  <div class="nav-icon active" data-screen="home" onclick="switchNav(this, 'home')" title="Home">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
    <span class="nav-label">Home</span>
  </div>
  <div class="nav-icon" data-screen="sublease" onclick="switchNav(this, 'sublease')" title="Sublease">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg>
    <span class="nav-label">Sublease</span>
  </div>
  <div class="nav-icon" data-screen="roommates" onclick="switchNav(this, 'roommates')" title="Roommates">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    <span class="nav-label">Roommates</span>
  </div>
  <div class="nav-icon" data-screen="map" onclick="switchNav(this, 'map')" title="Map">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
    <span class="nav-label">Map</span>
  </div>
  <div class="nav-icon" data-screen="assist" onclick="switchNav(this, 'assist')" title="Lease Help">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
    <span class="nav-label">Lease<br>Help</span>
  </div>
  <div class="nav-icon" data-screen="reviews" onclick="switchNav(this, 'reviews')" title="Reviews">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <span class="nav-label">Reviews</span>
  </div>
</nav>

<!-- Overlay Screens -->
<!-- SUBLEASE (Forum) -->
<div class="overlay-screen" id="screen-sublease">
  <button onclick="closeOverlay('screen-sublease')" class="btn btn-ghost" style="margin-bottom:40px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <h2 class="font-editorial" style="font-size:36px; color:#1A1A1A; margin-bottom:8px;">Sublease Forum</h2>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); line-height:1.7; margin-bottom:24px;">Find or post subleases. Real students, real deals.</p>

  <!-- Search bar (hidden by default) -->
  <div id="sublease-search" style="display:none; margin-bottom:16px;">
    <input type="text" id="sublease-search-input" class="editorial-input" placeholder="Search by property, price, or dates..." oninput="filterSubleases()" style="width:100%; padding:12px 16px; font-size:14px;">
  </div>

  <div style="display:flex; gap:8px; margin-bottom:24px;">
    <button class="btn btn-primary" style="flex:1;" onclick="toggleSubleaseForm()">+ New Post</button>
    <button class="btn btn-secondary" style="padding:12px 16px;" onclick="toggleSubleaseSearch()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button>
  </div>

  <!-- New post form (hidden by default) -->
  <div id="sublease-form" style="display:none; border:1px solid rgba(26,26,26,0.1); border-radius:12px; padding:20px; margin-bottom:24px; background:rgba(255,130,0,0.03);">
    <p class="font-body" style="font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:rgba(26,26,26,0.4); margin-bottom:16px;">New Sublease Post</p>
    <input type="text" id="sub-title" class="editorial-input" placeholder="Title (e.g. 1BR at Hub Knoxville)" style="width:100%; margin-bottom:12px;">
    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <input type="text" id="sub-price" class="editorial-input" placeholder="Price/mo" style="flex:1;">
      <input type="text" id="sub-dates" class="editorial-input" placeholder="Dates (e.g. Jan–Jul 2026)" style="flex:1;">
    </div>
    <input type="email" id="sub-email" class="editorial-input" placeholder="Your email (so interested renters can reach you)" style="width:100%; margin-bottom:12px;">
    <textarea id="sub-desc" class="editorial-input" placeholder="Description..." style="width:100%; min-height:60px; resize:vertical; margin-bottom:12px;"></textarea>
    <div style="display:flex; gap:8px;">
      <button class="btn btn-primary" style="flex:1;" onclick="submitSubleasePost()">Post</button>
      <button class="btn btn-secondary" onclick="toggleSubleaseForm()">Cancel</button>
    </div>
  </div>

  <!-- Listings container -->
  <div id="sublease-listings">
    <div id="sublease-empty" style="padding:48px 24px; text-align:center; border:1px dashed rgba(26,26,26,0.1); border-radius:12px;">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.15)" stroke-width="1" style="margin-bottom:16px;"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg>
      <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.4); margin-bottom:8px;">No subleases posted yet.</p>
      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.3);">Be the first — tap "+ New Post" above.</p>
    </div>
  </div>
</div>

<!-- ROOMMATES (Tinder-style) -->
<div class="overlay-screen" id="screen-roommates">
  <button onclick="closeOverlay('screen-roommates')" class="btn btn-ghost" style="margin-bottom:24px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <h2 class="font-editorial" style="font-size:36px; color:#1A1A1A; margin-bottom:8px;">Roommate Find</h2>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); line-height:1.7; margin-bottom:24px;">Swipe to match with compatible roommates. Early bird, clean freak, night owl — we've got you.</p>

  <!-- Setup state (no profile yet) -->
  <div id="roommate-setup">
    <div style="height:380px; border-radius:16px; overflow:hidden; position:relative; background:linear-gradient(180deg, #f0ede8 0%, #e8e4df 100%); border:1px dashed rgba(26,26,26,0.12); margin-bottom:24px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.15)" stroke-width="1" style="margin-bottom:20px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      <p class="font-editorial" style="font-size:22px; color:#1A1A1A; margin-bottom:8px;">Set up your profile</p>
      <p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.4); text-align:center; line-height:1.6; margin-bottom:24px;">Tell us about your lifestyle so we can match you with compatible roommates.</p>
      <button class="btn btn-primary" onclick="showRoommateProfileForm()">Create Profile</button>
    </div>
  </div>

  <!-- Profile form (hidden) -->
  <div id="roommate-form" style="display:none;">
    <div style="border:1px solid rgba(26,26,26,0.08); border-radius:12px; padding:24px; margin-bottom:24px;">
      <p class="font-body" style="font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:rgba(26,26,26,0.4); margin-bottom:20px;">Your Roommate Profile</p>

      <input type="text" id="rm-name" class="editorial-input" placeholder="Your name" style="width:100%; margin-bottom:12px;">
      <input type="email" id="rm-email" class="editorial-input" placeholder="Email (e.g. you@vols.utk.edu)" style="width:100%; margin-bottom:12px;">
      <input type="text" id="rm-major" class="editorial-input" placeholder="Major (e.g. Business)" style="width:100%; margin-bottom:12px;">
      <input type="text" id="rm-social" class="editorial-input" placeholder="Social media (e.g. @yourhandle)" style="width:100%; margin-bottom:12px;">

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px; margin-top:8px;">Gender</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-radio" data-group="gender" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Male</span>
        <span class="rm-radio" data-group="gender" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Female</span>
        <span class="rm-radio" data-group="gender" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Non-binary</span>
        <span class="rm-radio" data-group="gender" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Prefer not to say</span>
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px; margin-top:8px;">Where are you living?</p>
      <select id="rm-living" class="editorial-input" style="width:100%; margin-bottom:16px;">
        <option value="">Not decided yet</option>
      </select>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px; margin-top:8px;">Year in school</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-radio" data-group="year" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Freshman</span>
        <span class="rm-radio" data-group="year" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Sophomore</span>
        <span class="rm-radio" data-group="year" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Junior</span>
        <span class="rm-radio" data-group="year" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Senior</span>
        <span class="rm-radio" data-group="year" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Grad</span>
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Preferred bedroom type</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-radio" data-group="bed" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Studio</span>
        <span class="rm-radio" data-group="bed" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">1 Bed</span>
        <span class="rm-radio" data-group="bed" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">2 Bed</span>
        <span class="rm-radio" data-group="bed" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">3+ Bed</span>
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Monthly budget (per person)</p>
      <div style="display:flex; gap:12px; margin-bottom:16px;">
        <input type="number" id="rm-budget-min" class="editorial-input" placeholder="Min $" style="width:50%;">
        <input type="number" id="rm-budget-max" class="editorial-input" placeholder="Max $" style="width:50%;">
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Move-in timeframe</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-radio" data-group="movein" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">ASAP</span>
        <span class="rm-radio" data-group="movein" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Summer 2026</span>
        <span class="rm-radio" data-group="movein" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Fall 2026</span>
        <span class="rm-radio" data-group="movein" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Spring 2027</span>
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Sleep schedule</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-radio" data-group="sleep" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Early bird</span>
        <span class="rm-radio" data-group="sleep" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Night owl</span>
        <span class="rm-radio" data-group="sleep" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Flexible</span>
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:6px;">Cleanliness <span id="rm-clean-val" style="color:#FF8200; font-weight:600;">3</span> / 5</p>
      <input type="range" id="rm-cleanliness" min="1" max="5" value="3" oninput="document.getElementById('rm-clean-val').textContent=this.value" style="width:100%; margin-bottom:16px; accent-color:#FF8200;">

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:6px;">Noise tolerance <span id="rm-noise-val" style="color:#FF8200; font-weight:600;">3</span> / 5</p>
      <input type="range" id="rm-noise" min="1" max="5" value="3" oninput="document.getElementById('rm-noise-val').textContent=this.value" style="width:100%; margin-bottom:16px; accent-color:#FF8200;">

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Guest frequency</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-radio" data-group="guests" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Rarely</span>
        <span class="rm-radio" data-group="guests" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Sometimes</span>
        <span class="rm-radio" data-group="guests" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Often</span>
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Study habits</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-radio" data-group="study" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Library</span>
        <span class="rm-radio" data-group="study" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">At home</span>
        <span class="rm-radio" data-group="study" onclick="selectRmRadio(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Both</span>
      </div>

      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Lifestyle</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Has pets</span>
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">No pets pls</span>
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Social</span>
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Quiet</span>
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Smokes socially</span>
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">No smoking</span>
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">Drinks socially</span>
        <span class="rm-tag" onclick="toggleRmTag(this)" style="padding:8px 16px; border:1px solid rgba(26,26,26,0.12); border-radius:20px; font-size:13px; cursor:pointer; transition:all 0.2s;">No alcohol</span>
      </div>

      <button class="btn btn-primary" style="width:100%;" onclick="submitRoommateProfile()">Save & Start Matching</button>
    </div>
  </div>

  <!-- Match state (hidden, shown after profile saved) -->
  <div id="roommate-matching" style="display:none;">
    <!-- Profile summary card (collapsible) -->
    <div id="rm-profile-card" style="border:1px solid rgba(26,26,26,0.08); border-radius:12px; overflow:hidden; margin-bottom:20px;">
      <div style="padding:16px 20px; background:rgba(255,130,0,0.06); border-bottom:1px solid rgba(26,26,26,0.06); display:flex; align-items:center; justify-content:space-between;">
        <p class="font-body" style="font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:#FF8200; font-weight:600;">Your Profile</p>
        <button class="btn btn-ghost" style="font-size:11px; padding:4px 12px;" onclick="editRoommateProfile()">Edit</button>
      </div>
      <div style="padding:20px;" id="rm-profile-summary"></div>
    </div>

    <!-- Tab bar: Discover / Matches -->
    <div class="rm-tab-bar">
      <button class="active" onclick="switchRmTab('discover')">Discover</button>
      <button onclick="switchRmTab('matches')">Matches <span id="rm-match-count"></span></button>
    </div>

    <!-- DISCOVER TAB -->
    <div id="rm-discover-tab">
      <!-- Filter bar -->
      <div class="rm-filter-bar" id="rm-filter-bar"></div>
      <!-- Card stack -->
      <div class="rm-card-stack" id="rm-card-stack"></div>
      <!-- Action buttons -->
      <div class="rm-swipe-btns" id="rm-swipe-btns">
        <button class="rm-swipe-btn pass" onclick="triggerSwipe('left')">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <button class="rm-swipe-btn match" onclick="triggerSwipe('right')">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </button>
      </div>
    </div>

    <!-- MATCHES TAB (hidden initially) -->
    <div id="rm-matches-tab" style="display:none;"></div>
  </div>

  <!-- Match flash overlay -->
  <div class="rm-match-flash" id="rm-match-flash">
    <h2>It's a Match!</h2>
    <p id="rm-match-flash-text">You and Sarah are a great fit.</p>
  </div>
</div>

<!-- MAP -->
<div class="overlay-screen" id="screen-map">
  <button onclick="closeOverlay('screen-map')" class="btn btn-ghost" style="margin-bottom:24px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <h2 class="font-editorial" style="font-size:36px; color:#1A1A1A; margin-bottom:8px;">Map</h2>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); line-height:1.7; margin-bottom:24px;">Tap a pin to see apartment details.</p>
  <div id="leaflet-map" style="height:420px; border-radius:12px; overflow:hidden; z-index:0;"></div>
  <!-- Selected apartment card below map -->
  <div id="map-selected-card" style="display:none; margin-top:16px; border:1px solid rgba(26,26,26,0.08); border-radius:12px; overflow:hidden;">
    <div style="padding:16px 20px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <p class="font-editorial" style="font-size:18px; color:#1A1A1A;" id="map-card-name"></p>
        <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.5); margin-top:2px;" id="map-card-details"></p>
      </div>
      <div style="text-align:right;">
        <p class="font-editorial" style="font-size:18px; color:#FF8200;" id="map-card-price"></p>
      </div>
    </div>
    <div style="padding:0 20px 16px;">
      <button id="map-card-link" class="btn btn-primary" style="width:100%; display:flex; align-items:center; justify-content:center; gap:8px;" onclick="">Learn More</button>
    </div>
  </div>
</div>

<!-- LEASE ASSISTANCE (TurboTax-style) -->
<div class="overlay-screen" id="screen-assist">
  <button onclick="closeOverlay('screen-assist')" class="btn btn-ghost" style="margin-bottom:24px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <h2 class="font-editorial" style="font-size:36px; color:#1A1A1A; margin-bottom:8px;">Lease Help</h2>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); line-height:1.7; margin-bottom:24px;">Paste your lease and we'll break it down for you.</p>
  <div style="border:1px solid rgba(26,26,26,0.08); border-radius:12px; overflow:hidden;">
    <div style="padding:20px; border-bottom:1px solid rgba(26,26,26,0.06); display:flex; align-items:center; gap:16px;">
      <div style="width:36px; height:36px; border-radius:50%; background:#FF8200; color:white; display:flex; align-items:center; justify-content:center; font-weight:600;">1</div>
      <div>
        <p class="font-body" style="font-weight:600; color:#1A1A1A;">Read your lease carefully</p>
        <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.5);">We'll highlight key clauses — deposits, subletting, break fees.</p>
      </div>
    </div>
    <div style="padding:20px; border-bottom:1px solid rgba(26,26,26,0.06); display:flex; align-items:center; gap:16px; background:rgba(255,130,0,0.04);">
      <div style="width:36px; height:36px; border-radius:50%; background:#FF8200; color:white; display:flex; align-items:center; justify-content:center; font-weight:600;">2</div>
      <div>
        <p class="font-body" style="font-weight:600; color:#1A1A1A;">Upload or paste your lease</p>
        <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.5);">AI reviews it and explains in plain English.</p>
      </div>
    </div>
    <div style="padding:20px; display:flex; align-items:center; gap:16px;">
      <div style="width:36px; height:36px; border-radius:50%; border:2px solid rgba(26,26,26,0.2); display:flex; align-items:center; justify-content:center; font-weight:600;">3</div>
      <div>
        <p class="font-body" style="font-weight:600; color:rgba(26,26,26,0.5);">Get questions answered</p>
        <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4);">Chat with a leasing expert or use our FAQ.</p>
      </div>
    </div>
  </div>
  <div style="margin-top:24px;">
    <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px; letter-spacing:0.05em; text-transform:uppercase;">Paste your lease text below</p>
    <textarea id="lease-text-input" class="editorial-input" placeholder="Paste your lease agreement text here..." style="width:100%; min-height:140px; resize:vertical; margin-bottom:12px; font-size:13px; line-height:1.6;"></textarea>
    <button class="btn btn-primary" style="width:100%; padding:16px;" onclick="analyzeLease()">Analyze Lease</button>
  </div>
  <div id="lease-analysis-result" style="display:none; margin-top:24px;"></div>
</div>

<!-- REVIEWS (User-submitted) -->
<div class="overlay-screen" id="screen-reviews">
  <button onclick="closeOverlay('screen-reviews')" class="btn btn-ghost" style="margin-bottom:24px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <h2 class="font-editorial" style="font-size:36px; color:#1A1A1A; margin-bottom:8px;">Verified Reviews</h2>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); line-height:1.7; margin-bottom:24px;">Only from people who actually lived there. UT email verified ✓</p>

  <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
    <span style="padding:6px 12px; background:rgba(0,180,100,0.12); color:#00b464; border-radius:20px; font-size:12px; font-weight:500;">✓ Verified tenant</span>
    <select id="review-filter-property" onchange="renderUserReviews()" class="editorial-input" style="flex:1; font-size:12px; padding:8px 12px;">
      <option value="">All apartments</option>
    </select>
  </div>

  <button class="btn btn-primary" style="width:100%; margin-bottom:20px;" onclick="toggleReviewForm()">Write a Review</button>

  <!-- Review form (hidden) -->
  <div id="review-form" style="display:none; border:1px solid rgba(26,26,26,0.1); border-radius:12px; padding:20px; margin-bottom:24px; background:rgba(255,130,0,0.03);">
    <p class="font-body" style="font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:rgba(26,26,26,0.4); margin-bottom:16px;">New Review</p>
    <select id="review-property" class="editorial-input" style="width:100%; margin-bottom:12px;"></select>
    <div style="margin-bottom:12px;">
      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:8px;">Rating</p>
      <div id="review-stars-input" style="display:flex; gap:4px;">
        <span class="star" style="cursor:pointer; font-size:24px; opacity:0.3;" onclick="setReviewStars(1)">★</span>
        <span class="star" style="cursor:pointer; font-size:24px; opacity:0.3;" onclick="setReviewStars(2)">★</span>
        <span class="star" style="cursor:pointer; font-size:24px; opacity:0.3;" onclick="setReviewStars(3)">★</span>
        <span class="star" style="cursor:pointer; font-size:24px; opacity:0.3;" onclick="setReviewStars(4)">★</span>
        <span class="star" style="cursor:pointer; font-size:24px; opacity:0.3;" onclick="setReviewStars(5)">★</span>
      </div>
    </div>
    <textarea id="review-text" class="editorial-input" placeholder="Share your experience..." style="width:100%; min-height:80px; resize:vertical; margin-bottom:12px;"></textarea>
    <input type="text" id="review-author" class="editorial-input" placeholder="Your name (e.g. Sarah M.)" style="width:100%; margin-bottom:12px;">
    <div style="display:flex; gap:8px;">
      <button class="btn btn-primary" style="flex:1;" onclick="submitReview()">Submit</button>
      <button class="btn btn-secondary" onclick="toggleReviewForm()">Cancel</button>
    </div>
  </div>

  <!-- Reviews list -->
  <div id="reviews-list"></div>
</div>

<div class="overlay-screen" id="screen-alerts">
  <button onclick="closeOverlay('screen-alerts')" class="btn btn-ghost" style="margin-bottom:40px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <h2 class="font-editorial" style="font-size:36px; color:#1A1A1A; margin-bottom:16px;">Alerts</h2>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); line-height:1.7; margin-bottom:40px;">Get notified when prices drop, units open up, or new listings match your preferences. Never miss the perfect apartment.</p>
  <div style="padding:32px; border:1px solid rgba(26,26,26,0.08); border-radius:12px; text-align:center;">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.15)" stroke-width="1"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    <p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.3); margin-top:16px;">No alerts yet. Tap the bell on a listing.</p>
  </div>
</div>

<div class="overlay-screen" id="screen-property-detail" style="padding:0 0 120px;">
  <button onclick="closeOverlay('screen-property-detail')" class="btn btn-ghost" style="position:absolute; top:16px; left:16px; z-index:10; background:rgba(255,255,255,0.9); border-radius:50%; width:36px; height:36px; padding:0; display:flex; align-items:center; justify-content:center;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
  </button>
  <div id="detail-carousel-wrap">
    <div class="detail-carousel" id="detail-carousel"></div>
    <div class="carousel-dots" id="detail-dots"></div>
  </div>
  <div style="padding:24px 28px 0;">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:4px;">
      <div>
        <span id="detail-match" class="font-body" style="font-size:11px; color:white; background:#FF8200; padding:4px 10px; letter-spacing:0.08em; text-transform:uppercase; font-weight:500; display:inline-block; margin-bottom:8px;"></span>
        <h2 id="detail-name" class="font-editorial" style="font-size:28px; color:#1A1A1A; font-weight:400;"></h2>
      </div>
    </div>
    <p id="detail-tagline" class="font-body" style="font-size:12px; color:rgba(26,26,26,0.45); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:4px;"></p>
    <p id="detail-distance" class="font-body" style="font-size:13px; color:rgba(26,26,26,0.5); margin-bottom:16px;"></p>
    <div id="detail-stars-wrap" style="display:flex; align-items:center; gap:6px; margin-bottom:20px;"></div>

    <div style="margin-bottom:20px;">
      <h3 class="font-body" style="font-size:11px; text-transform:uppercase; letter-spacing:0.1em; color:rgba(26,26,26,0.4); margin-bottom:10px;">Floor Plans</h3>
      <div id="detail-plans"></div>
    </div>

    <div style="margin-bottom:20px;">
      <h3 class="font-body" style="font-size:11px; text-transform:uppercase; letter-spacing:0.1em; color:rgba(26,26,26,0.4); margin-bottom:10px;">Amenities</h3>
      <p id="detail-amenities" class="font-body" style="font-size:13px; color:rgba(26,26,26,0.65); line-height:1.6;"></p>
    </div>

    <div id="detail-parking-wrap" style="margin-bottom:20px; display:none;">
      <h3 class="font-body" style="font-size:11px; text-transform:uppercase; letter-spacing:0.1em; color:rgba(26,26,26,0.4); margin-bottom:6px;">Parking</h3>
      <p id="detail-parking" class="font-body" style="font-size:13px; color:rgba(26,26,26,0.65);"></p>
    </div>

    <div id="detail-special-wrap" style="margin-bottom:24px; display:none;">
      <p id="detail-special" class="font-body" style="font-size:13px; color:#00b464; font-weight:500;"></p>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:16px;">
      <button id="detail-select-btn" class="btn btn-primary" style="flex:1;" onclick="">Select</button>
      <div id="detail-fav-btn" style="flex-shrink:0; width:44px; height:44px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(26,26,26,0.1); border-radius:50%; transition:all 0.2s;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.3)" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </div>
    </div>

    <a id="detail-website-link" href="#" target="_blank" rel="noopener" class="font-body" style="font-size:11px; color:rgba(26,26,26,0.35); text-decoration:underline; display:block; text-align:center;">Visit official site</a>
  </div>
</div>

<div class="overlay-screen" id="screen-select-confirm" style="display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
  <button onclick="closeOverlay('screen-select-confirm')" class="btn btn-ghost" style="position:absolute; top:60px; left:36px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <div style="margin-bottom:24px;">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#00b464" stroke-width="1.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
  </div>
  <h2 class="font-editorial" style="font-size:32px; color:#1A1A1A; margin-bottom:12px;">You're all set!</h2>
  <p id="select-confirm-name" class="font-body" style="font-size:16px; color:#FF8200; font-weight:600; margin-bottom:8px;"></p>
  <p id="select-confirm-price" class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); margin-bottom:24px;"></p>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.6); line-height:1.7; max-width:280px;">Thanks for your selection! You'll receive an application within <strong>24–48 hours</strong>.</p>
  <p id="submit-status" class="font-body" style="font-size:12px; margin-top:16px; opacity:0; transition:opacity 0.4s;"></p>
  <button onclick="closeOverlay('screen-select-confirm')" class="btn btn-primary" style="margin-top:24px; padding:14px 40px;">Back to Results</button>
</div>

<div class="overlay-screen" id="screen-profile">
  <button onclick="closeOverlay('screen-profile')" class="btn btn-ghost" style="margin-bottom:40px; display:flex; align-items:center; gap:8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    <span class="font-body" style="font-size:12px; letter-spacing:0.1em; text-transform:uppercase;">Back</span>
  </button>
  <h2 class="font-editorial" style="font-size:36px; color:#1A1A1A; margin-bottom:16px;">Profile</h2>
  <p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); line-height:1.7; margin-bottom:40px;">Your preferences, saved searches, and account settings. Refine your taste over time.</p>
  
  <div style="display:flex; align-items:center; gap:16px; padding:24px 0; border-bottom:1px solid rgba(26,26,26,0.06);">
    <div style="width:48px; height:48px; border-radius:50%; background:#FF8200; display:flex; align-items:center; justify-content:center;">
      <span class="font-editorial" style="color:white; font-size:18px;" id="profile-initials">SL</span>
    </div>
    <div>
      <p class="font-body" style="font-size:16px; color:#1A1A1A;" id="profile-name">Smart Lease User</p>
      <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4);">UT Knoxville</p>
    </div>
  </div>

  <div style="margin-top:24px;">
    <div style="padding:16px 0; border-bottom:1px solid rgba(26,26,26,0.06); display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="closeOverlay('screen-profile'); retakeSurvey();">
      <span class="font-body" style="font-size:14px; color:#1A1A1A;">Retake Quiz</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.3)" stroke-width="1.5"><path d="M9 18l6-6-6-6"/></svg>
    </div>
    <div style="padding:16px 0; border-bottom:1px solid rgba(26,26,26,0.06); display:flex; justify-content:space-between; align-items:center;">
      <span class="font-body" style="font-size:14px; color:#1A1A1A;">Notification Settings</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.3)" stroke-width="1.5"><path d="M9 18l6-6-6-6"/></svg>
    </div>
    <div style="padding:16px 0; border-bottom:1px solid rgba(26,26,26,0.06); display:flex; justify-content:space-between; align-items:center;">
      <span class="font-body" style="font-size:14px; color:#1A1A1A;">Help & Support</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.3)" stroke-width="1.5"><path d="M9 18l6-6-6-6"/></svg>
    </div>
  </div>
</div>

<script>
// ============================================
// APARTMENT DATA (with attributes for filtering)
// ============================================
// 21 Knoxville-area student apartments near UT · Web-verified Feb 2026
// prices = per-person monthly rent keyed by bedroom type (ONLY types the property actually offers)
// Sources: property websites, UTK off-campus housing portal, apartment listing sites
const APARTMENTS_DATA = [
  { name:'Hub Knoxville', prices:{'Studio':1199,'2 Bed':1419,'3 Bed':1620,'4 Bed':1174,'5 Bed':1415}, baths:{'Studio':1,'2 Bed':1,'3 Bed':2,'4 Bed':2,'5 Bed':3}, bedrooms:'Studio', parking:'$185/mo', amenities:['Pool','Gym','Study Room'], distanceMi:0.4, images:['https://hubknoxville.com/wp-content/uploads/2025/10/Hub-Knoxville-index-hero-1.webp','https://hubknoxville.com/wp-content/uploads/2025/10/Hub-Knox_Gallery_Kitchen.webp','https://hubknoxville.com/wp-content/uploads/2025/10/Hub-Knox_Gallery_Living-Space-2.webp','https://hubknoxville.com/wp-content/uploads/2025/10/Hub-Knoxville-amenities-7.webp','https://hubknoxville.com/wp-content/uploads/2025/10/Hub-Knox_Gallery_Lobby-2.webp'], stars:0, reviews:0, reviewText:'Modern finishes and great location. Rooftop lounge is the spot.', reviewAuthor:'Sarah M.', reviewClass:"'27", tagline:'the popular pick', website:'https://hubknoxville.com/' },
  { name:'University Walk', prices:{'1 Bed':1899,'2 Bed':1199,'3 Bed':1049,'4 Bed':899}, baths:{'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4}, bedrooms:'2 Bed', special:'Waived fees + $400 savings + half-off parking', amenities:['Parking','Gym','Furnished'], distanceMi:0.7, images:['https://universitywalkknox.com/wp-content/uploads/2025/10/Student_Quarters_University_Walk_01-scaled.jpg','https://universitywalkknox.com/wp-content/uploads/2025/10/Student_Quarters_University_Walk_17-scaled.jpg','https://universitywalkknox.com/wp-content/uploads/2025/10/Student_Quarters_University_Walk_11-scaled.jpg','https://universitywalkknox.com/wp-content/uploads/2025/10/Student_Quarters_University_Walk_22-scaled.jpg'], stars:3.0, reviews:7, reviewText:'Furnished units made move-in so easy. Solid value.', reviewAuthor:'James K.', reviewClass:"'26", tagline:'best value', website:'https://universitywalkknox.com/' },
  { name:'The Knox Apartments', prices:{'3 Bed':930,'4 Bed':885,'5 Bed':850}, baths:{'3 Bed':3,'4 Bed':4,'5 Bed':4}, bedrooms:'4 Bed', amenities:['Pool','Gym','Study Room'], distanceMi:0.3, images:['https://livetheknox.com/wp-content/uploads/2022/04/index-header-1600x800-c-default.jpg','https://livetheknox.com/wp-content/uploads/2022/04/0000_Workout-1024x485-c-default.jpg','https://livetheknox.com/wp-content/uploads/2022/04/0001_TV-Lounge-1024x485-c-default.jpg','https://livetheknox.com/wp-content/uploads/2022/04/0002_Pool-Table-Dining-1024x485-c-default.jpg','https://livetheknox.com/wp-content/uploads/2022/04/0006_Deck-3-1024x485-c-default.jpg'], stars:4.6, reviews:561, reviewText:'Best decision freshman year. Study rooms saved my GPA.', reviewAuthor:'Maya P.', reviewClass:"'27", tagline:'steps from class', website:'https://livetheknox.com/' },
  { name:'The Standard at Knoxville', prices:{'1 Bed':1790,'2 Bed':1380,'3 Bed':1390,'4 Bed':1335,'5 Bed':1370}, baths:{'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4,'5 Bed':5}, bedrooms:'2 Bed', parking:'$210/mo', special:'Flash Sale on select 2x2 & 4x4!', amenities:['Pool','Gym','Study Room','Laundry'], distanceMi:0.2, images:['https://www.thestandardatknoxville.com/wp-content/uploads/2023/07/Standard-at-Knoxville-gallery-hero.jpg','https://www.thestandardatknoxville.com/wp-content/uploads/2023/07/Standard-at-Knoxville-community-gallery-15.jpg','https://www.thestandardatknoxville.com/wp-content/uploads/2023/07/Standard-at-Knoxville-community-gallery-1.jpg','https://www.thestandardatknoxville.com/wp-content/uploads/2023/07/Standard-at-Knoxville-community-gallery-17.jpg'], stars:3.5, reviews:252, reviewText:'Right on campus. Literally roll out of bed to class.', reviewAuthor:'Alex N.', reviewClass:"'28", tagline:'right on campus', website:'https://www.thestandardatknoxville.com/' },
  { name:'Villas Knoxville', prices:{'Studio':1571,'1 Bed':1843,'2 Bed':1299,'3 Bed':1199,'4 Bed':1029,'5 Bed':975}, baths:{'Studio':1,'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4,'5 Bed':5}, bedrooms:'2 Bed', soldOut:['Studio'], special:'Waived App, Admin & Signing Fees — save $500', amenities:['Parking','Laundry','Pet Friendly'], distanceMi:1.1, images:['https://villasknoxville.com/wp-content/uploads/2025/07/25.07.11-VK-Party-Deck-dusk-11.webp','https://villasknoxville.com/wp-content/uploads/2025/07/25.07.11-VK-Pool-Deck-dusk-1.webp','https://villasknoxville.com/wp-content/uploads/2025/03/Villas-Knoxville_3R_S3.webp','https://villasknoxville.com/wp-content/uploads/2025/03/Villas-Knoxville_1R_C1_TH-Combined.webp'], stars:0, reviews:0, reviewText:'Pet-friendly with nice grounds. Great for my dog.', reviewAuthor:'Tyler R.', reviewClass:"'27", tagline:'pet friendly', website:'https://www.villasknoxville.com/' },
  { name:'The Commons at Knoxville', prices:{'1 Bed':1615,'2 Bed':1019,'3 Bed':959,'4 Bed':890}, baths:{'1 Bed':1,'2 Bed':1,'3 Bed':2,'4 Bed':2}, bedrooms:'2 Bed', special:'Last month FREE on 1-Bed units (sign by 2/28)', amenities:['Gym','Laundry','Furnished'], distanceMi:0.9, images:['https://images.squarespace-cdn.com/content/v1/6490b536ff0b1623acfcc5f9/3f9fd716-d1cc-4731-a64c-d36fd68e56f3/The+Commons+Knoxville-poi-020.jpg','https://images.squarespace-cdn.com/content/v1/6490b536ff0b1623acfcc5f9/44d68413-9fbe-4869-afb0-13e5f6f2928b/The+Commons+Knoxville-poi-018.jpg','https://images.squarespace-cdn.com/content/v1/6490b536ff0b1623acfcc5f9/cac550b5-e9ed-4d7b-9bdc-97af0c2fd59a/The+Commons+at+Knoxville-POI-17.jpg','https://images.squarespace-cdn.com/content/v1/6490b536ff0b1623acfcc5f9/6aa6a03f-2799-42e6-8364-5974e74f5543/The+Commons+Knoxville-poi-021.jpg'], stars:3.0, reviews:6, reviewText:'Clean, quiet, good WiFi. Perfect for studying.', reviewAuthor:'Jordan T.', reviewClass:"'26", tagline:'quiet & clean', website:'https://commonsatknoxville.com/' },
  { name:'Slate at 901', prices:{'2 Bed':1500,'3 Bed':1515,'4 Bed':1225}, baths:{'2 Bed':2,'3 Bed':3,'4 Bed':2}, bedrooms:'2 Bed', amenities:['Pool','Gym','Game Room'], distanceMi:0.5, images:['https://slateat901.com/wp-content/uploads/2025/02/EvolveLifestyle08-min.webp','https://slateat901.com/wp-content/uploads/2025/11/006A8312.jpg','https://slateat901.com/wp-content/uploads/2025/11/006A8417-e1762451423602.jpg','https://slateat901.com/wp-content/uploads/2025/11/006A8247.jpg'], stars:3.9, reviews:184, reviewText:'If you love socializing, this is the spot.', reviewAuthor:'Sam D.', reviewClass:"'28", tagline:'social butterfly', website:'https://slateat901.com/' },
  { name:'TENN', prices:{'3 Bed':1359,'4 Bed':1340,'5 Bed':1340}, baths:{'3 Bed':2,'4 Bed':4,'5 Bed':5}, bedrooms:'4 Bed', amenities:['Pool','Gym','Study Room','Furnished'], distanceMi:0.2, images:['https://www.cube3.com/wp-content/uploads/2016/04/TENN-4.jpg','https://www.cube3.com/wp-content/uploads/2016/04/TENN-5.jpg','https://www.cube3.com/wp-content/uploads/2016/04/TENN-6.jpg','https://cdn.universityliving.com/cms/gG1ONzRz6GqvF1o2AU49XTN51A0ujy.webp'], stars:3.8, reviews:45, reviewText:'Premium everything. Worth the splurge for location.', reviewAuthor:'Chris L.', reviewClass:"'27", tagline:'premium vibes', website:'https://www.tennstudentliving.com/' },
  { name:'Tradition at Knoxville', prices:{'1 Bed':1030,'2 Bed':799}, baths:{'1 Bed':1,'2 Bed':1}, bedrooms:'2 Bed', special:'Code LIVETRAD for free application', amenities:['Parking','Laundry','Pet Friendly'], distanceMi:1.8, images:['https://www.traditionknoxville.com/wp-content/uploads/2024/04/traditionknoxville-gallery-hero2024.jpg','https://www.traditionknoxville.com/wp-content/uploads/2023/06/traditionknoxville-gallery-1.jpg','https://www.traditionknoxville.com/wp-content/uploads/2023/06/traditionknoxville-gallery-2.jpg','https://www.traditionknoxville.com/wp-content/uploads/2023/06/traditionknoxville-gallery-5.jpg'], stars:3.5, reviews:15, reviewText:'Cheapest for a shared unit. Worth the drive.', reviewAuthor:'Morgan B.', reviewClass:"'26", tagline:'best for groups', website:'https://www.traditionknoxville.com/' },
  { name:'303 Flats', prices:{'1 Bed':1799,'2 Bed':1175,'3 Bed':1125,'4 Bed':999}, baths:{'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4}, bedrooms:'2 Bed', special:'Free parking OR $1,500 concession (first 10 leases)', amenities:['Pool','Parking','Study Room'], distanceMi:0.6, images:['https://media.wbir.com/assets/WBIR/images/588760875/588760875_1920x1080.jpg','https://media.wbir.com/assets/WBIR/images/588768219/588768219_1920x1080.jpg','https://media.wbir.com/assets/WBIR/images/588768228/588768228_1920x1080.jpg','https://media.wbir.com/assets/WBIR/images/588768243/588768243_1920x1080.jpg'], stars:4.8, reviews:13, reviewText:'Pool parties every weekend. Great community.', reviewAuthor:'Jordan T.', reviewClass:"'28", tagline:'pool parties', website:'https://www.303flatsapts.com/' },
  { name:'The Davy', prices:{'1 Bed':1879,'2 Bed':1309,'3 Bed':1299,'4 Bed':999}, baths:{'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4}, bedrooms:'2 Bed', special:'Special pricing on select 2-Bed & 4-Bed plans', amenities:['Gym','Laundry','Game Room'], distanceMi:0.5, images:['https://thedavyknox.com/wp-content/uploads/2024/11/Exterior-2.png','https://thedavyknox.com/wp-content/uploads/2024/11/Pool-1.png','https://thedavyknox.com/wp-content/uploads/2024/11/Hammock.png','https://thedavyknox.com/wp-content/uploads/2024/11/Hot-Tub.png','https://thedavyknox.com/wp-content/uploads/2024/11/Courtyard.png'], stars:4.0, reviews:1, reviewText:'Game room always packed on weekends. Fun vibe.', reviewAuthor:'Tyler R.', reviewClass:"'27", tagline:'game room gang', website:'https://thedavyknox.com/' },
  { name:'The Heights', prices:{'2 Bed':999,'3 Bed':899,'4 Bed':759}, baths:{'2 Bed':2,'3 Bed':3,'4 Bed':2}, bedrooms:'2 Bed', amenities:['Pool','Parking','Study Room'], distanceMi:2.3, images:['https://live-theheights.com/wp-content/uploads/2025/07/featured_image.jpg','https://live-theheights.com/wp-content/uploads/2025/09/HOK_Lifestyle_1.webp','https://live-theheights.com/wp-content/uploads/2025/09/HOK_Lifestyle_2.webp','https://live-theheights.com/wp-content/uploads/2025/10/kitchen-2.webp'], stars:3.3, reviews:260, reviewText:'Shuttle to campus included. Great community.', reviewAuthor:'Sarah M.', reviewClass:"'28", tagline:'shuttle included', website:'https://live-theheights.com/' },
  { name:'Knox Ridge', prices:{'4 Bed':999,'5 Bed':979}, baths:{'4 Bed':4,'5 Bed':5}, bedrooms:'4 Bed', parking:'Free', amenities:['Parking','Laundry'], distanceMi:3.0, images:['https://www.knoxridge.com/wp-content/uploads/2025/12/Hero-image-2-1600x800-c-default.png','https://www.knoxridge.com/wp-content/uploads/2022/04/index-clubroom.jpg','https://www.knoxridge.com/wp-content/uploads/2022/04/amenities-gallery-1-1024x485-c-default.jpg','https://www.knoxridge.com/wp-content/uploads/2022/04/amenities-gallery-2-1024x485-c-default.jpg','https://www.knoxridge.com/wp-content/uploads/2025/09/home-kitchen-new.webp'], stars:3.5, reviews:38, reviewText:'Townhomes with a lazy river pool. Worth the shuttle ride.', reviewAuthor:'Chris L.', reviewClass:"'26", tagline:'lazy river pool', website:'https://www.knoxridge.com/' },
  { name:'The Woodlands', prices:{'2 Bed':855,'3 Bed':790,'4 Bed':720}, baths:{'2 Bed':2,'3 Bed':3,'4 Bed':4}, bedrooms:'2 Bed', parking:'Free', amenities:['Gym','Parking','Pet Friendly'], distanceMi:2.9, images:['https://www.woodlandsofknoxville.com/wp-content/uploads/woodlands_knox_61918_pool5-min-scaled.jpg','https://www.woodlandsofknoxville.com/wp-content/uploads/Clubhouse-Inside-scaled.jpg','https://www.woodlandsofknoxville.com/wp-content/uploads/Fitness-Center-3-scaled.jpg','https://www.woodlandsofknoxville.com/wp-content/uploads/IMG_2278-scaled.jpeg'], stars:3.4, reviews:8, reviewText:'Quiet, wooded setting. Nice escape from campus bustle.', reviewAuthor:'Alex N.', reviewClass:"'27", tagline:'quiet woods', website:'https://www.woodlandsofknoxville.com/' },
  { name:'The Mark', prices:{'Studio':1499,'1 Bed':1669,'2 Bed':1199,'3 Bed':1099,'4 Bed':999,'5 Bed':949}, baths:{'Studio':1,'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4,'5 Bed':5}, bedrooms:'2 Bed', parking:'Free option available', special:'$500 gift card look-and-lease; code LOVEMARK waived fees', amenities:['Pool','Gym','Study Room','Furnished'], distanceMi:0.4, images:['https://www.themarkknoxville.com/wp-content/uploads/2025/10/the-mark-knoxville-index-hero.webp','https://www.themarkknoxville.com/wp-content/uploads/2025/10/the-mark-knoxville-index-community.webp','https://www.themarkknoxville.com/wp-content/uploads/2025/10/the-mark-knoxville-index-amenities.webp','https://www.themarkknoxville.com/wp-content/uploads/2025/10/the-mark-knoxville-gallery-1.webp','https://www.themarkknoxville.com/wp-content/uploads/2025/10/the-mark-knoxville-gallery-10.webp'], stars:0, reviews:0, reviewText:'Luxury feel without the downtown price tag.', reviewAuthor:'Maya P.', reviewClass:"'28", tagline:'luxury feel', website:'https://themarkknoxville.com/' },
  { name:'Ever', prices:{'1 Bed':1735,'2 Bed':1775,'3 Bed':1735,'4 Bed':1409,'5 Bed':1375}, baths:{'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4,'5 Bed':5}, bedrooms:'2 Bed', soldOut:['1 Bed'], special:'Waived signing fees — save $450', amenities:['Pool','Gym','Laundry'], distanceMi:0.5, images:['https://everknoxville.com/wp-content/themes/yootheme/cache/7e/ever-knoxville-436_F_Birdview-7eefd0c9.jpeg','https://everknoxville.com/wp-content/themes/yootheme/cache/4c/ever-knoxville-436_F_Pool_cam3_still-4c63a77e.jpeg','https://everknoxville.com/wp-content/themes/yootheme/cache/a3/ever-knoxville-436_F_Sauna_Still-a329bb67.jpeg','https://everknoxville.com/wp-content/themes/yootheme/cache/8f/436_F_Fitness_cam1-scaled-8f858137.jpeg','https://everknoxville.com/wp-content/themes/yootheme/cache/22/ever-knoxville-436_F_Lobby_still-22b93b17.jpeg'], stars:0, reviews:0, reviewText:'Premium new build near Sorority Village. Worth the splurge.', reviewAuthor:'Sam D.', reviewClass:"'27", tagline:'premium new build', website:'https://everknoxville.com/' },
  { name:'Livano', prices:{'Studio':1905,'1 Bed':1819,'2 Bed':1200,'3 Bed':1190}, baths:{'Studio':1,'1 Bed':1,'2 Bed':2,'3 Bed':2}, bedrooms:'Studio', special:'Up to 2 months free!', amenities:['Gym','Laundry','Furnished'], distanceMi:0.8, images:['https://lirp.cdn-website.com/03bab791/dms3rep/multi/opt/Livano+Apartments-1-1920w.jpg','https://irp.cdn-website.com/03bab791/dms3rep/multi/Livano+Knoxville-1.jpg','https://irp.cdn-website.com/03bab791/dms3rep/multi/Livano+Knoxville-30.jpg','https://irp.cdn-website.com/03bab791/dms3rep/multi/Livano+Apartments-21.jpg'], stars:4.0, reviews:1, reviewText:'Luxury riverfront with Game Day Sky Lounge.', reviewAuthor:'James K.', reviewClass:"'26", tagline:'riverfront luxury', website:'https://www.livanoknoxville.com/' },
  { name:'Flagship Kerns Apartments', prices:{'1 Bed':1795,'2 Bed':799}, baths:{'1 Bed':1,'2 Bed':2}, bedrooms:'2 Bed', parking:'Free', special:'$799/bed on 2-Bed — only 5 left!', amenities:['Parking','Laundry','Gym'], distanceMi:1.0, images:['https://images.rentable.co/76250/47082078/large.jpg','https://images.rentable.co/76250/47082080/large.jpg','https://images.rentable.co/76250/47082077/large.jpg','https://images.rentable.co/76250/47082079/large.jpg'], stars:4.2, reviews:9, reviewText:'Solid value. Good gym and parking.', reviewAuthor:'Morgan B.', reviewClass:"'28", tagline:'solid value', website:'https://flagshipkerns.com/' },
  { name:'Nova Knoxville', prices:{'1 Bed':1790,'2 Bed':1485,'4 Bed':1360,'5 Bed':1290}, baths:{'1 Bed':1,'2 Bed':2,'4 Bed':4,'5 Bed':5}, bedrooms:'2 Bed', special:'1 month free + waived app fees', amenities:['Pool','Gym','Study Room'], distanceMi:0.5, images:['https://novaknoxville.b-cdn.net/wp-content/uploads/2023/08/Nova-Knoxville-Off-Campus-Apartments-Near-The-University-of-Tennessee-Knoxville-Open-Floor-Plan-Fully-Furnished-Living-Room-to-Kitchen.jpg','https://novaknoxville.b-cdn.net/wp-content/uploads/2023/08/Nova-Knoxville-Off-Campus-Apartments-Near-The-University-of-Tennessee-Knoxville-Rooftop-Pool.jpg','https://novaknoxville.b-cdn.net/wp-content/uploads/2023/08/Nova-Knoxville-Off-Campus-Apartments-Near-The-University-of-Tennessee-Knoxville-Resident-Clubhouse-Business-Center-Private-and-Collaborative-Study-Areas.jpg','https://novaknoxville.b-cdn.net/wp-content/uploads/2023/08/Nova-Knoxville-Off-Campus-Apartments-Near-The-University-of-Tennessee-Knoxville-24-Hour-Fitness-Center-Cardio-Machines.jpg'], stars:4.5, reviews:13, reviewText:'Modern building, great study spaces.', reviewAuthor:'Jordan T.', reviewClass:"'27", tagline:'modern living', website:'https://novaknoxville.com/' },
  { name:'Quarry Trail', prices:{'1 Bed':1485,'2 Bed':1095,'3 Bed':899,'4 Bed':880}, baths:{'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4}, bedrooms:'3 Bed', parking:'$50/yr', soldOut:['1 Bed','2 Bed','3 Bed','4 Bed'], special:'$200 gift card for look-and-lease within 48hrs', amenities:['Parking','Laundry','Pet Friendly'], distanceMi:3.8, images:['https://quarrytrail.com/wp-content/uploads/2025/09/01_3999_Highland_Crest_Way_Knoxville_TN_37920_USA-Exterior-_MG_7417-1024x683.jpg','https://quarrytrail.com/wp-content/uploads/2025/09/13_3999_Highland_Crest_Way_Knoxville_TN_37920_USA-Foyer-_MG_7495.jpg','https://quarrytrail.com/wp-content/uploads/2024/11/3999_Highland_Crest_Way_Knoxville_TN_37920_USA-Kitchen-_MG_0917.jpg','https://quarrytrail.com/wp-content/uploads/2020/10/Querry-Trails_Millions-of-dollars-in-renovations_05.jpg'], stars:3.8, reviews:19, reviewText:'Cheapest option with a campus shuttle. Worth the ride.', reviewAuthor:'Chris L.', reviewClass:"'26", tagline:'budget friendly', website:'https://quarrytrail.com/' },
  { name:'Union Knoxville', prices:{'Studio':1800,'1 Bed':1890,'2 Bed':1475,'3 Bed':1640,'4 Bed':1360,'5 Bed':1330}, baths:{'Studio':1,'1 Bed':1,'2 Bed':2,'3 Bed':3,'4 Bed':4,'5 Bed':5}, bedrooms:'Studio', amenities:['Pool','Gym','Game Room','Furnished'], distanceMi:0.3, images:['https://s7d9.scene7.com/is/image/greystarprod/20474RND1','https://s7d9.scene7.com/is/image/greystarprod/20474RND2','https://s7d9.scene7.com/is/image/greystarprod/20474RND3','https://s7d9.scene7.com/is/image/greystarprod/20474RND4'], stars:4.5, reviews:161, reviewText:'Steps from The Rock. Best location in Knoxville.', reviewAuthor:'Sarah M.', reviewClass:"'28", tagline:'best location', website:'https://offcampushousing.utk.edu/housing/property/union-knoxville/smvqsg4' },
];

// ============================================
// STATE
// ============================================
let currentSection = 'section-cover';
let currentQuestion = 1;
let priorityRank = 0;
let selectedBedroom = null;
let selectedDistance = null;
let userName = '';

// ============================================
// SECTION NAVIGATION
// ============================================
function goToSection(sectionId) {
  // Hide current
  const current = document.getElementById(currentSection);
  current.style.opacity = '0';
  
  setTimeout(() => {
    current.classList.remove('active');
    current.style.display = 'none';
    
    // Show new
    const next = document.getElementById(sectionId);
    next.style.display = 'flex';
    next.style.opacity = '0';
    
    // Force reflow
    next.offsetHeight;
    
    setTimeout(() => {
      next.classList.add('active');
      next.style.opacity = '1';
    }, 50);
    
    currentSection = sectionId;
    
    // Scroll to top
    document.getElementById('app-scroll').scrollTop = 0;
    
    // Show progress bar for quiz
    const progressBar = document.getElementById('progress-bar');
    if (sectionId === 'section-quiz') {
      progressBar.classList.add('visible');
      updateProgress();
    } else if (sectionId === 'section-results') {
      progressBar.classList.remove('visible');
      showBottomNav();
      updateProfileInfo();
    } else {
      progressBar.classList.remove('visible');
    }
  }, 400);
}

// ============================================
// ONBOARDING FORM
// ============================================
function checkFieldProgress(fieldNum) {
  const input = document.querySelector(`#field-${fieldNum} input`);
  const value = input.value.trim();
  
  if (value.length >= 2 && fieldNum < 4) {
    const nextField = document.getElementById(`field-${fieldNum + 1}`);
    if (!nextField.classList.contains('active')) {
      setTimeout(() => {
        nextField.classList.add('active');
      }, 300);
    }
  }
  
  // Check if enough fields are filled to continue
  const firstName = document.getElementById('input-first').value.trim();
  const lastName = document.getElementById('input-last').value.trim();
  const email = document.getElementById('input-email').value.trim();
  
  const continueBtn = document.getElementById('story-continue');
  if (firstName.length >= 2 && lastName.length >= 2 && email.length >= 5) {
    continueBtn.style.opacity = '1';
    continueBtn.style.pointerEvents = 'all';
    userName = firstName;
  } else {
    continueBtn.style.opacity = '0.25';
    continueBtn.style.pointerEvents = 'none';
  }
}

// ============================================
// QUIZ NAVIGATION
// ============================================
function nextQuestion(num) {
  const current = document.getElementById(`quiz-q${currentQuestion}`);
  current.style.opacity = '0';
  
  setTimeout(() => {
    current.classList.remove('active');
    current.style.display = 'none';
    
    // Reset priority rankings when entering Q5 so user can re-rank
    if (num === 5) {
      priorityRank = 0;
      document.querySelectorAll('#priority-list .priority-item').forEach(item => {
        item.classList.remove('ranked');
        item.querySelector('.priority-num').textContent = '';
      });
      const finishBtn = document.getElementById('q5-finish');
      finishBtn.style.opacity = '0.2';
      finishBtn.style.pointerEvents = 'none';
    }
    
    const next = document.getElementById(`quiz-q${num}`);
    next.style.display = 'flex';
    next.style.opacity = '0';
    next.offsetHeight;
    
    setTimeout(() => {
      next.classList.add('active');
      next.style.opacity = '1';
    }, 50);
    
    currentQuestion = num;
    updateProgress();
    
    document.getElementById('app-scroll').scrollTop = 0;
  }, 350);
}

function prevQuestion(num) {
  const current = document.getElementById(`quiz-q${currentQuestion}`);
  current.style.opacity = '0';
  
  setTimeout(() => {
    current.classList.remove('active');
    current.style.display = 'none';
    
    const prev = document.getElementById(`quiz-q${num}`);
    prev.style.display = 'flex';
    prev.style.opacity = '0';
    prev.offsetHeight;
    
    setTimeout(() => {
      prev.classList.add('active');
      prev.style.opacity = '1';
    }, 50);
    
    currentQuestion = num;
    updateProgress();
  }, 350);
}

function updateProgress() {
  const fill = document.getElementById('progress-fill');
  const pct = (currentQuestion / 5) * 100;
  fill.style.width = pct + '%';
}

// ============================================
// Q1: BEDROOMS
// ============================================
function selectBedroom(el, value) {
  document.querySelectorAll('#quiz-q1 .quiz-tile').forEach(t => t.classList.remove('selected'));
  el.classList.add('selected');
  selectedBedroom = value;
  
  const btn = document.getElementById('q1-next');
  btn.style.opacity = '1';
  btn.style.pointerEvents = 'all';
}

// ============================================
// Q2: BUDGET (dual-range)
// ============================================
function updateBudgetRange() {
  const minSlider = document.getElementById('budget-min');
  const maxSlider = document.getElementById('budget-max');
  let minVal = parseInt(minSlider.value);
  let maxVal = parseInt(maxSlider.value);
  if (minVal > maxVal) {
    const tmp = minVal; minVal = maxVal; maxVal = tmp;
    minSlider.value = minVal;
    maxSlider.value = maxVal;
  }
  document.getElementById('budget-display').textContent = '$' + minVal.toLocaleString() + ' — $' + maxVal.toLocaleString();
  document.getElementById('budget-min-input').value = '$' + minVal.toLocaleString();
  document.getElementById('budget-max-input').value = '$' + maxVal.toLocaleString();
  const totalRange = 2500 - 500;
  const leftPct = ((minVal - 500) / totalRange) * 100;
  const rightPct = ((maxVal - 500) / totalRange) * 100;
  const fill = document.getElementById('range-fill');
  fill.style.left = leftPct + '%';
  fill.style.width = (rightPct - leftPct) + '%';
}
function updateBudgetFromInput() {
  const parseVal = (str) => parseInt(str.replace(/[^0-9]/g, '')) || 500;
  let minVal = parseVal(document.getElementById('budget-min-input').value);
  let maxVal = parseVal(document.getElementById('budget-max-input').value);
  minVal = Math.max(500, Math.min(2500, Math.round(minVal / 50) * 50));
  maxVal = Math.max(500, Math.min(2500, Math.round(maxVal / 50) * 50));
  if (minVal > maxVal) { const tmp = minVal; minVal = maxVal; maxVal = tmp; }
  document.getElementById('budget-min').value = minVal;
  document.getElementById('budget-max').value = maxVal;
  updateBudgetRange();
}

// ============================================
// Q3: AMENITIES
// ============================================
function toggleAmenity(el) {
  el.classList.toggle('checked');
}

// ============================================
// Q4: DISTANCE
// ============================================
function selectDistance(el, value) {
  document.querySelectorAll('.distance-opt').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
  selectedDistance = value;
  
  const btn = document.getElementById('q4-next');
  btn.style.opacity = '1';
  btn.style.pointerEvents = 'all';
}

// ============================================
// Q5: PRIORITY
// ============================================
function rankPriority(el) {
  if (el.classList.contains('ranked')) return;
  
  priorityRank++;
  if (priorityRank > 4) return;
  
  el.classList.add('ranked');
  el.querySelector('.priority-num').textContent = priorityRank;
  
  if (priorityRank >= 4) {
    const btn = document.getElementById('q5-finish');
    btn.style.opacity = '1';
    btn.style.pointerEvents = 'all';
  }
}

// ============================================
// SURVEY-AWARE FILTERING & RESULTS
// ============================================
function getSelectedAmenities() {
  const checks = document.querySelectorAll('.amenity-check.checked');
  return Array.from(checks).map(c => c.dataset.amenity).filter(Boolean);
}
function getPriorityOrder() {
  const items = document.querySelectorAll('#priority-list .priority-item.ranked');
  return Array.from(items).sort((a,b) => parseInt(a.querySelector('.priority-num').textContent) - parseInt(b.querySelector('.priority-num').textContent)).map(i => i.dataset.label);
}
function getBudgetMin() {
  return parseInt(document.getElementById('budget-min')?.value || 700);
}
function getBudgetMax() {
  return parseInt(document.getElementById('budget-max')?.value || 1400);
}
function isSoldOut(apt, bedType) {
  return Array.isArray(apt.soldOut) && apt.soldOut.includes(bedType);
}
function isAllSoldOut(apt) {
  if (!Array.isArray(apt.soldOut) || apt.soldOut.length === 0) return false;
  return Object.keys(apt.prices).every(k => apt.soldOut.includes(k));
}
function bedFallbackChain(wanted) {
  const order = ['Studio','1 Bed','2 Bed','3 Bed','4 Bed','5 Bed'];
  const idx = order.indexOf(wanted);
  if (idx === -1) return [wanted];
  const chain = [wanted];
  for (let i = idx - 1; i >= 0; i--) chain.push(order[i]);
  for (let i = idx + 1; i < order.length; i++) chain.push(order[i]);
  chain.push('3+ Bed');
  return chain;
}
function findBestBedKey(apt, wanted) {
  if (!wanted) return null;
  const chain = bedFallbackChain(wanted);
  for (const key of chain) { if (apt.prices[key] !== undefined) return key; }
  return null;
}
function resolvePrice(apt) {
  if (!apt.prices) return 0;
  const key = findBestBedKey(apt, selectedBedroom);
  if (key) {
    if (!isSoldOut(apt, key)) return apt.prices[key];
    const fallback = Object.keys(apt.prices).find(k => k !== key && !isSoldOut(apt, k));
    if (fallback) return apt.prices[fallback];
    return apt.prices[key];
  }
  return apt.prices[apt.bedrooms] || Object.values(apt.prices)[0];
}
function resolveBedLabel(apt) {
  const key = findBestBedKey(apt, selectedBedroom);
  if (key) {
    if (!isSoldOut(apt, key)) return key;
    const fallback = Object.keys(apt.prices).find(k => k !== key && !isSoldOut(apt, k));
    if (fallback) return fallback;
    return key;
  }
  return apt.bedrooms;
}
function resolveBedBathLabel(apt) {
  const bed = resolveBedLabel(apt);
  const bathCount = apt.baths && apt.baths[bed];
  return bathCount ? bed + ' / ' + bathCount + ' Bath' : bed;
}
function computeFilteredResults() {
  const budgetMin = getBudgetMin();
  const budgetMax = getBudgetMax();
  const amenities = getSelectedAmenities();
  const priorities = getPriorityOrder();
  const wantedBed = selectedBedroom || null;
  const distMax = !selectedDistance ? 999 : selectedDistance === 'walking' ? 0.5 : selectedDistance === 'biking' ? 1.5 : 999;
  let filtered = APARTMENTS_DATA.filter(apt => {
    if (wantedBed && !findBestBedKey(apt, wantedBed)) return false;
    const price = resolvePrice(apt);
    if (price < budgetMin - 100 || price > budgetMax + 100) return false;
    if (apt.distanceMi > distMax) return false;
    return true;
  });
  if (filtered.length === 0) filtered = APARTMENTS_DATA;
  const midBudget = (budgetMin + budgetMax) / 2;
  filtered = filtered.map(apt => {
    const price = resolvePrice(apt);
    const allOut = isAllSoldOut(apt);
    const resolvedKey = findBestBedKey(apt, wantedBed);
    const bedSoldOut = resolvedKey && isSoldOut(apt, resolvedKey);
    const fallbackBed = bedSoldOut && !allOut;
    let score = 50;
    if (allOut) score = 5;
    else {
      const matchAm = apt.amenities.filter(a => amenities.includes(a)).length;
      const amenityScore = Math.min(10, matchAm * 3);
      let priceScore = 0;
      if (price >= budgetMin && price <= budgetMax) priceScore = 10;
      else { const priceDist = Math.abs(price - midBudget); priceScore = Math.max(0, 10 - priceDist / 100); }
      const locScore = apt.distanceMi <= 0.3 ? 10 : apt.distanceMi <= 0.5 ? 8 : apt.distanceMi <= 1 ? 5 : apt.distanceMi <= 2 ? 2 : 0;
      const reviewScore = apt.reviews > 0 ? Math.min(10, (apt.stars / 5) * 10) : 5;
      score += amenityScore + priceScore + locScore + reviewScore;
      const weights = [20, 12, 6, 2];
      priorities.forEach((key, idx) => {
        const w = weights[idx] || 1;
        if (key === 'Price') score += priceScore / 10 * w;
        else if (key === 'Location') score += locScore / 10 * w;
        else if (key === 'Amenities') score += amenityScore / 10 * w;
        else if (key === 'Reviews') score += reviewScore / 10 * w;
      });
      if (bedSoldOut) score -= 15;
    }
    return { ...apt, _resolvedPrice: price, matchScore: Math.min(99, Math.max(1, Math.round(score))), _allSoldOut: !!allOut, _soldOut: !!bedSoldOut, _fallbackBed: !!(bedSoldOut && !allOut) };
  });
  filtered.sort((a,b) => b.matchScore - a.matchScore);
  const available = filtered.filter(a => !a._allSoldOut);
  const soldOutItems = filtered.filter(a => a._allSoldOut);
  return [...available, ...soldOutItems].slice(0, 6);
}

// Results displayed as swipeable cards (v3-style, v1 aesthetic)
let displayedResults = [];
let currentCardIndex = 0;

function renderResults() {
  let results = computeFilteredResults();
  if (showingFavoritesOnly) {
    const favs = getFavorites();
    results = results.filter(apt => favs.includes(apt.name));
  }
  window._lastResults = results;
  displayedResults = results;
  currentCardIndex = 0;
  const stack = document.getElementById('card-stack');
  const colophon = document.getElementById('results-colophon');
  const hint = document.getElementById('swipe-hint');

  if (results.length === 0) {
    stack.innerHTML = '<div style="padding:48px 24px; text-align:center;"><p class="font-body" style="color:rgba(26,26,26,0.5);">No matches found. Try adjusting your filters!</p><button onclick="goToSection(\'section-quiz\')" class="btn btn-primary" style="margin-top:24px;">Retake Quiz</button></div>';
    colophon.style.display = 'none';
    document.getElementById('card-dots').innerHTML = '';
    document.getElementById('btn-prev-card').style.display = 'none';
    document.getElementById('btn-next-card').style.display = 'none';
    return;
  }

  stack.innerHTML = '';
  results.forEach((apt, i) => {
    const full = Math.floor(apt.stars);
    const hasHalf = apt.stars % 1 >= 0.5;
    const empty = 5 - full - (hasHalf ? 1 : 0);
    const starsFull = '★'.repeat(full);
    const starHalf = hasHalf ? '<span class="star" style="opacity:0.6">★</span>' : '';
    const starsEmpty = '★'.repeat(empty);
    const amenityStr = apt.amenities.join(' · ');
    const website = apt.website || 'https://offcampushousing.utk.edu/';
    const distanceStr = apt.distanceMi + ' mi to campus';

    const card = document.createElement('div');
    card.className = 'result-apt-card';
    card.id = 'card-' + i;
    card.style.zIndex = results.length - i;
    if (i !== 0) {
      card.style.transform = `scale(${1 - i * 0.05}) translateY(${i * 12}px)`;
      card.style.opacity = i === 1 ? '0.7' : '0.4';
    }
    if (i > 1) card.style.pointerEvents = 'none';

    const cardOpacity = apt._allSoldOut ? 'opacity:0.45;' : '';
    const soldOutBanner = apt._allSoldOut
      ? '<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:5; background:rgba(26,26,26,0.85); color:white; padding:12px 28px; border-radius:8px; font-size:14px; font-weight:600; letter-spacing:0.08em; text-transform:uppercase;">Sold Out</div>'
      : apt._fallbackBed
        ? '<div style="padding:8px 16px; background:rgba(214,158,46,0.1); border-bottom:1px solid rgba(214,158,46,0.15);"><p class="font-body" style="font-size:11px; color:#d69e2e; font-weight:500;">' + (selectedBedroom || '') + ' sold out — showing ' + resolveBedLabel(apt) + ' price</p></div>'
        : '';
    const matchBadgeColor = apt._allSoldOut ? 'rgba(26,26,26,0.4)' : '#FF8200';
    const priceColor = apt._allSoldOut ? 'rgba(26,26,26,0.35)' : '#FF8200';

    card.innerHTML = `
      <div style="position:relative; ${cardOpacity}">
      <img src="${(apt.images && apt.images[0]) || ''}" alt="${apt.name}" class="card-image" draggable="false">
      ${apt._allSoldOut ? '<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:5; background:rgba(26,26,26,0.85); color:white; padding:12px 28px; border-radius:8px; font-size:14px; font-weight:600; letter-spacing:0.08em; text-transform:uppercase;">Sold Out</div>' : ''}
      <div style="position:absolute; top:16px; left:16px; padding:6px 14px; background:${matchBadgeColor}; color:white; font-size:11px; letter-spacing:0.1em; text-transform:uppercase; font-weight:500;">${apt._allSoldOut ? 'Sold Out' : apt.matchScore + '% Match'}</div>
      <div style="position:absolute; top:16px; right:16px; padding:6px 12px; background:rgba(255,255,255,0.95); font-size:11px; color:rgba(26,26,26,0.7);">${apt.tagline || ''}</div>
      </div>
      ${apt._fallbackBed ? '<div style="padding:8px 16px; background:rgba(214,158,46,0.1); border-bottom:1px solid rgba(214,158,46,0.15);"><p class="font-body" style="font-size:11px; color:#d69e2e; font-weight:500;">' + (selectedBedroom || '') + ' sold out — showing ' + resolveBedLabel(apt) + ' price</p></div>' : ''}
      <div class="card-content" style="${apt._allSoldOut ? 'opacity:0.5;' : ''}">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
          <div>
            <h3 class="font-editorial" style="font-size:24px; color:#1A1A1A; font-weight:400;">${apt.name}</h3>
            <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.5); margin-top:4px;">${distanceStr}</p>
          </div>
          <div style="text-align:right;">
            <p class="font-editorial" style="font-size:22px; color:${priceColor};">${apt._allSoldOut ? '<s>$' + (apt._resolvedPrice || resolvePrice(apt)).toLocaleString() + '</s>' : '$' + (apt._resolvedPrice || resolvePrice(apt)).toLocaleString() + '/mo'}</p>
            <p class="font-body" style="font-size:10px; color:rgba(26,26,26,0.35); margin-top:2px;">${resolveBedBathLabel(apt)}</p>
            <div style="display:flex; align-items:center; gap:4px; justify-content:flex-end; margin-top:4px;">
              ${apt.reviews > 0 ? '<span class="star">' + starsFull + '</span>' + starHalf + '<span class="star" style="opacity:0.3;">' + starsEmpty + '</span><span class="font-body" style="font-size:11px; color:rgba(26,26,26,0.4);">' + apt.stars + ' (' + apt.reviews + ')</span>' : '<span class="font-body" style="font-size:11px; color:#FF8200; background:rgba(255,130,0,0.1); padding:2px 8px; border-radius:4px; font-weight:500;">New</span>'}
            </div>
          </div>
        </div>
        <p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.6); line-height:1.5; margin-bottom:${(apt.parking || apt.special) ? '8' : '16'}px;">${amenityStr}</p>
        ${apt.parking ? '<p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.5); margin-bottom:' + (apt.special ? '8' : '16') + 'px;"><span style="font-weight:600;">Parking:</span> ' + apt.parking + '</p>' : ''}
        ${apt.special ? '<p class="font-body" style="font-size:11px; color:#00b464; margin-bottom:16px; font-weight:500;">✦ ' + apt.special + '</p>' : ''}
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn btn-primary" style="flex:1; min-width:110px;" onclick="openPropertyDetail(${i})">${apt._allSoldOut ? 'View Details' : 'Learn More'}</button>
          ${apt._allSoldOut ? '' : '<button class="btn btn-secondary" style="flex:1; min-width:90px;" onclick="selectApartment(\'' + apt.name.replace(/'/g, "\\'") + '\', ' + (apt._resolvedPrice || 0) + ')">Select</button>'}
          <div onclick="toggleFavorite('${apt.name.replace(/'/g, "\\'")}')" style="flex-shrink:0; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(26,26,26,0.1); border-radius:50%; transition:all 0.2s;" class="fav-heart" data-apt="${apt.name}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="${isFavorited(apt.name) ? '#e53e3e' : 'none'}" stroke="${isFavorited(apt.name) ? '#e53e3e' : 'rgba(26,26,26,0.3)'}" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          </div>
        </div>
      </div>
    `;
    stack.appendChild(card);
    setupResultCardDrag(card, i);
  });

  colophon.style.display = 'block';
  document.getElementById('btn-prev-card').style.display = 'flex';
  document.getElementById('btn-next-card').style.display = 'flex';
  renderResultDots();
  updateResultNavButtons();
}

function renderResultDots() {
  const container = document.getElementById('card-dots');
  container.innerHTML = '';
  displayedResults.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = 'card-dot' + (i === currentCardIndex ? ' active' : '');
    container.appendChild(dot);
  });
}

function updateResultNavButtons() {
  document.getElementById('btn-prev-card').disabled = currentCardIndex === 0;
  document.getElementById('btn-next-card').disabled = currentCardIndex >= displayedResults.length - 1;
}

function animateToResultCard(index) {
  if (index < 0 || index >= displayedResults.length) return;
  currentCardIndex = index;
  displayedResults.forEach((_, i) => {
    const card = document.getElementById('card-' + i);
    if (!card) return;
    const offset = i - currentCardIndex;
    if (offset < 0) {
      card.style.transform = 'translateX(-120%) rotate(-10deg)';
      card.style.opacity = '0';
      card.style.pointerEvents = 'none';
    } else if (offset === 0) {
      card.style.transform = 'scale(1) translateY(0)';
      card.style.opacity = '1';
      card.style.zIndex = 10;
      card.style.pointerEvents = 'auto';
    } else if (offset === 1) {
      card.style.transform = 'scale(0.95) translateY(12px)';
      card.style.opacity = '0.6';
      card.style.zIndex = 5;
      card.style.pointerEvents = 'none';
    } else {
      card.style.transform = 'scale(0.9) translateY(24px)';
      card.style.opacity = '0.3';
      card.style.zIndex = 1;
      card.style.pointerEvents = 'none';
    }
  });
  renderResultDots();
  updateResultNavButtons();
  const hint = document.getElementById('swipe-hint');
  if (hint) hint.style.opacity = '0';
}

function prevResultCard() {
  if (currentCardIndex > 0) animateToResultCard(currentCardIndex - 1);
}

function nextResultCard() {
  if (currentCardIndex < displayedResults.length - 1) animateToResultCard(currentCardIndex + 1);
}

function setupResultCardDrag(card, index) {
  let startX = 0, startY = 0, currentX = 0, isDragging = false, isHorizontal = null;
  const onStart = (e) => {
    if (index !== currentCardIndex) return;
    isDragging = true;
    isHorizontal = null;
    const pt = e.type === 'mousedown' ? e : e.touches[0];
    startX = pt.clientX;
    startY = pt.clientY;
    card.style.transition = 'none';
  };
  const onMove = (e) => {
    if (!isDragging) return;
    const pt = e.type === 'mousemove' ? e : e.touches[0];
    const dx = pt.clientX - startX;
    const dy = pt.clientY - startY;
    if (isHorizontal === null && (Math.abs(dx) > 8 || Math.abs(dy) > 8)) {
      isHorizontal = Math.abs(dx) > Math.abs(dy);
    }
    if (isHorizontal === false) { isDragging = false; return; }
    if (isHorizontal) { e.preventDefault(); }
    currentX = dx;
    card.style.transform = `translateX(${currentX}px) rotate(${currentX * 0.06}deg)`;
  };
  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    isHorizontal = null;
    card.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease';
    if (Math.abs(currentX) > 60) {
      if (currentX < 0 && currentCardIndex < displayedResults.length - 1) nextResultCard();
      else if (currentX > 0 && currentCardIndex > 0) prevResultCard();
      else card.style.transform = 'scale(1) translateY(0)';
    } else {
      card.style.transform = 'scale(1) translateY(0)';
    }
    currentX = 0;
  };
  card.addEventListener('mousedown', onStart);
  card.addEventListener('mousemove', onMove);
  card.addEventListener('mouseup', onEnd);
  card.addEventListener('mouseleave', onEnd);
  card.addEventListener('touchstart', onStart, { passive: true });
  card.addEventListener('touchmove', onMove, { passive: false });
  card.addEventListener('touchend', onEnd);
}
function showResults() {
  saveSurveyAnswers();
  renderResults();
  goToSection('section-results');
}

function retakeSurvey() {
  selectedBedroom = null;
  selectedDistance = null;
  priorityRank = 0;
  document.querySelectorAll('#quiz-q1 .quiz-tile').forEach(t => t.classList.remove('selected'));
  document.querySelectorAll('.amenity-check').forEach(c => c.classList.remove('checked'));
  document.querySelectorAll('.distance-opt').forEach(d => d.classList.remove('selected'));
  document.querySelectorAll('#priority-list .priority-item').forEach(item => {
    item.classList.remove('ranked');
    item.querySelector('.priority-num').textContent = '';
  });
  const q1Btn = document.getElementById('q1-next');
  q1Btn.style.opacity = '0.2'; q1Btn.style.pointerEvents = 'none';
  const q4Btn = document.getElementById('q4-next');
  q4Btn.style.opacity = '0.2'; q4Btn.style.pointerEvents = 'none';
  const q5Btn = document.getElementById('q5-finish');
  q5Btn.style.opacity = '0.2'; q5Btn.style.pointerEvents = 'none';
  document.querySelectorAll('.quiz-question').forEach(q => {
    q.classList.remove('active'); q.style.display = 'none'; q.style.opacity = '0';
  });
  const savedUser = getSavedUser();
  if (savedUser) {
    currentQuestion = 1;
    const q1 = document.getElementById('quiz-q1');
    q1.style.display = 'flex'; q1.classList.add('active'); q1.style.opacity = '1';
    document.getElementById('bottom-nav').classList.remove('visible');
    document.querySelectorAll('.overlay-screen').forEach(s => s.classList.remove('visible'));
    goToSection('section-quiz');
  } else {
    currentQuestion = 1;
    const q1 = document.getElementById('quiz-q1');
    q1.style.display = 'flex'; q1.classList.add('active'); q1.style.opacity = '1';
    document.getElementById('bottom-nav').classList.remove('visible');
    document.querySelectorAll('.overlay-screen').forEach(s => s.classList.remove('visible'));
    goToSection('section-story');
  }
}

function toggleAlert(el) {
  el.classList.toggle('active');
}

// ============================================
// FAVORITES
// ============================================
function getFavorites() {
  try { return JSON.parse(localStorage.getItem('smartlease_favorites') || '[]'); } catch(e) { return []; }
}
function saveFavorites(arr) {
  localStorage.setItem('smartlease_favorites', JSON.stringify(arr));
}
function isFavorited(aptName) {
  return getFavorites().includes(aptName);
}
function toggleFavorite(aptName) {
  let favs = getFavorites();
  if (favs.includes(aptName)) {
    favs = favs.filter(f => f !== aptName);
  } else {
    favs.push(aptName);
  }
  saveFavorites(favs);
  document.querySelectorAll('.fav-heart').forEach(el => {
    if (el.getAttribute('data-apt') === aptName) {
      const svg = el.querySelector('svg path');
      const isFav = favs.includes(aptName);
      svg.setAttribute('fill', isFav ? '#e53e3e' : 'none');
      svg.setAttribute('stroke', isFav ? '#e53e3e' : 'rgba(26,26,26,0.3)');
    }
  });
  updateFavoritesButton();
}
let showingFavoritesOnly = false;
function toggleFavoritesView() {
  showingFavoritesOnly = !showingFavoritesOnly;
  const btn = document.getElementById('btn-favorites-filter');
  if (showingFavoritesOnly) {
    btn.style.background = '#FF8200';
    btn.style.color = 'white';
    btn.style.borderColor = '#FF8200';
  } else {
    btn.style.background = '';
    btn.style.color = '';
    btn.style.borderColor = '';
  }
  renderResults();
}
function updateFavoritesButton() {
  const btn = document.getElementById('btn-favorites-filter');
  if (!btn) return;
  const count = getFavorites().length;
  btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="' + (count > 0 ? '#e53e3e' : 'none') + '" stroke="' + (count > 0 ? '#e53e3e' : 'currentColor') + '" stroke-width="1.5" style="display:inline-block; vertical-align:-2px; margin-right:6px;"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>Favorites' + (count > 0 ? ' (' + count + ')' : '');
}

// ============================================
// SELECT APARTMENT
// ============================================
function openPropertyDetail(aptIndexOrName) {
  let apt;
  if (typeof aptIndexOrName === 'number') {
    const results = window._lastResults || [];
    apt = results[aptIndexOrName];
  } else {
    apt = APARTMENTS_DATA.find(a => a.name === aptIndexOrName);
    if (apt && !apt.matchScore) apt.matchScore = 0;
  }
  if (!apt) return;
  const imgs = apt.images || [];
  const carousel = document.getElementById('detail-carousel');
  const dots = document.getElementById('detail-dots');
  carousel.innerHTML = imgs.map(u => '<img src="' + u + '" alt="' + apt.name + '" draggable="false">').join('');
  dots.innerHTML = imgs.map((_, j) => '<span class="dot' + (j === 0 ? ' active' : '') + '"></span>').join('');
  carousel.scrollLeft = 0;
  carousel.onscroll = function() {
    const idx = Math.round(carousel.scrollLeft / carousel.offsetWidth);
    dots.querySelectorAll('.dot').forEach((d, k) => d.classList.toggle('active', k === idx));
  };

  document.getElementById('detail-name').textContent = apt.name;
  document.getElementById('detail-tagline').textContent = apt.tagline || '';
  document.getElementById('detail-match').textContent = apt._allSoldOut ? 'Sold Out' : apt.matchScore + '% Match';
  document.getElementById('detail-match').style.background = apt._allSoldOut ? 'rgba(26,26,26,0.4)' : '#FF8200';
  document.getElementById('detail-distance').textContent = apt.distanceMi + ' mi to campus';

  const starsWrap = document.getElementById('detail-stars-wrap');
  if (apt.reviews > 0) {
    const full = Math.floor(apt.stars);
    const hasHalf = apt.stars % 1 >= 0.5;
    const empty = 5 - full - (hasHalf ? 1 : 0);
    starsWrap.innerHTML = '<span class="star">' + '★'.repeat(full) + '</span>' + (hasHalf ? '<span class="star" style="opacity:0.6">★</span>' : '') + '<span class="star" style="opacity:0.3">' + '★'.repeat(empty) + '</span><span class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4);">' + apt.stars + ' (' + apt.reviews + ' reviews)</span>';
  } else {
    starsWrap.innerHTML = '<span class="font-body" style="font-size:12px; color:#FF8200; background:rgba(255,130,0,0.1); padding:3px 10px; border-radius:4px; font-weight:500;">New</span>';
  }

  const selectedBed = JSON.parse(localStorage.getItem('smartlease_survey') || '{}').bedrooms || '';
  const plansDiv = document.getElementById('detail-plans');
  const soldOutArr = apt.soldOut || [];
  let plansHtml = '';
  Object.keys(apt.prices).forEach(bed => {
    const isSold = soldOutArr.includes(bed);
    const isMatch = (bed === resolveBedLabel(apt));
    const bathCount = apt.baths && apt.baths[bed];
    const bathStr = bathCount ? ' / ' + bathCount + ' Bath' : '';
    plansHtml += '<div class="detail-plan-row' + (isSold ? ' sold-out' : '') + (isMatch ? ' matched' : '') + '">';
    plansHtml += '<span class="font-body" style="font-size:13px; color:#1A1A1A;">' + bed + bathStr + (isMatch ? ' <span style="font-size:10px; color:#FF8200; font-weight:600;">YOUR MATCH</span>' : '') + '</span>';
    plansHtml += '<span class="font-body" style="font-size:13px; ' + (isSold ? 'color:rgba(26,26,26,0.35);' : 'color:#FF8200; font-weight:600;') + '">$' + apt.prices[bed].toLocaleString() + '/mo' + (isSold ? ' — Sold Out' : '') + '</span>';
    plansHtml += '</div>';
  });
  plansDiv.innerHTML = plansHtml;

  document.getElementById('detail-amenities').textContent = apt.amenities.join(' · ');

  const parkWrap = document.getElementById('detail-parking-wrap');
  if (apt.parking) { parkWrap.style.display = 'block'; document.getElementById('detail-parking').textContent = apt.parking; }
  else { parkWrap.style.display = 'none'; }

  const specWrap = document.getElementById('detail-special-wrap');
  if (apt.special) { specWrap.style.display = 'block'; document.getElementById('detail-special').textContent = '✦ ' + apt.special; }
  else { specWrap.style.display = 'none'; }

  const selBtn = document.getElementById('detail-select-btn');
  if (apt._allSoldOut) {
    selBtn.textContent = 'Join Waitlist';
    selBtn.onclick = function() { window.open(apt.website, '_blank'); };
  } else {
    selBtn.textContent = 'Select';
    selBtn.onclick = function() { closeOverlay('screen-property-detail'); selectApartment(apt.name, apt._resolvedPrice || resolvePrice(apt)); };
  }

  const favBtn = document.getElementById('detail-fav-btn');
  const fav = isFavorited(apt.name);
  favBtn.querySelector('svg').setAttribute('fill', fav ? '#e53e3e' : 'none');
  favBtn.querySelector('svg').setAttribute('stroke', fav ? '#e53e3e' : 'rgba(26,26,26,0.3)');
  favBtn.onclick = function() { toggleFavorite(apt.name); const f2 = isFavorited(apt.name); this.querySelector('svg').setAttribute('fill', f2 ? '#e53e3e' : 'none'); this.querySelector('svg').setAttribute('stroke', f2 ? '#e53e3e' : 'rgba(26,26,26,0.3)'); };

  document.getElementById('detail-website-link').href = apt.website || '#';

  document.getElementById('screen-property-detail').scrollTop = 0;
  openOverlay('screen-property-detail');
}

/*
 * ============================================
 * GOOGLE SHEETS INTEGRATION — SETUP INSTRUCTIONS
 * ============================================
 *
 * 1. Go to https://sheets.google.com and create a new spreadsheet
 * 2. In Row 1, add these headers (one per column):
 *    Timestamp | First Name | Last Name | Email | Phone | Bedrooms | Budget | Apartment | Price | Distance | Match Score
 *
 * 3. Go to Extensions > Apps Script
 * 4. Delete any existing code and paste this:
 *
 *    function doPost(e) {
 *      var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
 *      var data = JSON.parse(e.postData.contents);
 *      sheet.appendRow([
 *        data.timestamp,
 *        data.firstName,
 *        data.lastName,
 *        data.email,
 *        data.phone,
 *        data.bedrooms,
 *        data.budget,
 *        data.apartment,
 *        data.price,
 *        data.distance,
 *        data.matchScore
 *      ]);
 *      return ContentService.createTextOutput(
 *        JSON.stringify({ status: 'ok' })
 *      ).setMimeType(ContentService.MimeType.JSON);
 *    }
 *
 * 5. Click Deploy > New deployment
 * 6. Select type: Web app
 * 7. Set "Execute as" to your account
 * 8. Set "Who has access" to "Anyone"
 * 9. Click Deploy, authorize, then copy the Web app URL
 * 10. Paste that URL below replacing 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'
 */
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwQnf8UAbarqAlCdAiZu7M-8Q7VWDVCmveFkY6Fa7KsOtLWBPiQRa8g2J2CApNRwv2A/exec';

function submitToSheet(aptName, price) {
  if (!GOOGLE_SHEET_URL || GOOGLE_SHEET_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
    console.warn('SmartLease: Google Sheet URL not configured. Submission queued locally.');
    queueSubmission(aptName, price);
    updateSubmitIndicator('queued');
    return;
  }
  const user = getSavedUser() || {};
  const survey = (function() { try { return JSON.parse(localStorage.getItem('smartlease_survey')); } catch(e) { return {}; } })();
  const results = window._lastResults || [];
  const matched = results.find(a => a.name === aptName) || APARTMENTS_DATA.find(a => a.name === aptName);
  const payload = {
    timestamp: new Date().toISOString(),
    firstName: user.firstName || '',
    lastName: user.lastName || '',
    email: user.email || '',
    phone: user.phone || '',
    bedrooms: survey.bedroom || '',
    budget: survey.budgetMin && survey.budgetMax ? '$' + survey.budgetMin + '–$' + survey.budgetMax : '',
    apartment: aptName,
    price: '$' + price.toLocaleString(),
    distance: matched ? matched.distanceMi + ' mi' : '',
    matchScore: matched && matched.matchScore ? matched.matchScore + '%' : ''
  };

  fetch(GOOGLE_SHEET_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(function() {
    updateSubmitIndicator('sent');
    clearPendingQueue();
  }).catch(function() {
    queueSubmission(aptName, price);
    updateSubmitIndicator('queued');
  });
}

function queueSubmission(aptName, price) {
  const queue = JSON.parse(localStorage.getItem('smartlease_pending') || '[]');
  queue.push({ aptName: aptName, price: price, time: new Date().toISOString() });
  localStorage.setItem('smartlease_pending', JSON.stringify(queue));
}

function retryPendingSubmissions() {
  if (!GOOGLE_SHEET_URL || GOOGLE_SHEET_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') return;
  const queue = JSON.parse(localStorage.getItem('smartlease_pending') || '[]');
  if (queue.length === 0) return;
  queue.forEach(function(item) { submitToSheet(item.aptName, item.price); });
  localStorage.removeItem('smartlease_pending');
}

function clearPendingQueue() {
  localStorage.removeItem('smartlease_pending');
}

function updateSubmitIndicator(status) {
  const el = document.getElementById('submit-status');
  if (!el) return;
  if (status === 'sent') {
    el.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00b464" stroke-width="2" style="vertical-align:middle;"><polyline points="20 6 9 17 4 12"/></svg> <span style="color:#00b464;">Submission received</span>';
    el.style.opacity = '1';
  } else if (status === 'queued') {
    el.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#d69e2e" stroke-width="2" style="vertical-align:middle;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> <span style="color:#d69e2e;">Saved locally — will sync when online</span>';
    el.style.opacity = '1';
  }
}

function selectApartment(aptName, price) {
  localStorage.setItem('smartlease_selected', JSON.stringify({ name: aptName, price: price, time: new Date().toISOString() }));
  document.getElementById('select-confirm-name').textContent = aptName;
  document.getElementById('select-confirm-price').textContent = '$' + price.toLocaleString() + '/mo';
  const statusEl = document.getElementById('submit-status');
  if (statusEl) { statusEl.innerHTML = ''; statusEl.style.opacity = '0'; }
  openOverlay('screen-select-confirm');
  submitToSheet(aptName, price);
}

// ============================================
// BOTTOM NAV
// ============================================
function showBottomNav() {
  setTimeout(() => {
    document.getElementById('bottom-nav').classList.add('visible');
  }, 800);
}

function switchNav(el, screen) {
  // Reset all icons
  document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
  el.classList.add('active');
  
  // Close any open overlays
  document.querySelectorAll('.overlay-screen').forEach(s => s.classList.remove('visible'));
  
  if (screen === 'home') {
    // Just show results
    return;
  }
  
  const overlay = document.getElementById('screen-' + screen);
  if (overlay) {
    setTimeout(() => overlay.classList.add('visible'), 50);
    if (screen === 'map') setTimeout(buildMap, 100);
    if (screen === 'reviews') { populateReviewDropdowns(); renderUserReviews(); }
  }
}

function openOverlay(id) {
  const overlay = document.getElementById(id);
  if (overlay) setTimeout(() => overlay.classList.add('visible'), 50);
}
function closeOverlay(id) {
  document.getElementById(id).classList.remove('visible');
  document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
  document.querySelector('.nav-icon[data-screen="home"]').classList.add('active');
}
// ============================================
// SUBLEASE FORUM
// ============================================
let subleasePostsData = [];
function toggleSubleaseForm() {
  const form = document.getElementById('sublease-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  if (form.style.display === 'block') {
    const emailField = document.getElementById('sub-email');
    if (!emailField.value) {
      const user = getSavedUser();
      if (user && user.email) emailField.value = user.email;
    }
  }
}
function toggleSubleaseSearch() {
  const bar = document.getElementById('sublease-search');
  bar.style.display = bar.style.display === 'none' ? 'block' : 'none';
  if (bar.style.display === 'block') document.getElementById('sublease-search-input').focus();
}
function submitSubleasePost() {
  const title = document.getElementById('sub-title').value.trim();
  const price = document.getElementById('sub-price').value.trim();
  const dates = document.getElementById('sub-dates').value.trim();
  const email = document.getElementById('sub-email').value.trim();
  const desc = document.getElementById('sub-desc').value.trim();
  if (!title) return;
  if (!email || !email.includes('@')) { document.getElementById('sub-email').style.border = '1.5px solid #e53e3e'; document.getElementById('sub-email').focus(); return; }
  document.getElementById('sub-email').style.border = '';
  subleasePostsData.push({ title, price, dates, email, desc, time: 'Just now' });
  document.getElementById('sub-title').value = '';
  document.getElementById('sub-price').value = '';
  document.getElementById('sub-dates').value = '';
  document.getElementById('sub-email').value = '';
  document.getElementById('sub-desc').value = '';
  toggleSubleaseForm();
  renderSubleaseListings();
}
function deleteSubleasePost(index) {
  subleasePostsData.splice(index, 1);
  renderSubleaseListings();
}
function renderSubleaseListings(filter) {
  const container = document.getElementById('sublease-listings');
  const q = (filter || '').toLowerCase();
  const posts = q ? subleasePostsData.filter(p => (p.title + p.price + p.dates + p.desc).toLowerCase().includes(q)) : subleasePostsData;
  if (posts.length === 0) {
    container.innerHTML = '<div id="sublease-empty" style="padding:48px 24px; text-align:center; border:1px dashed rgba(26,26,26,0.1); border-radius:12px;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.15)" stroke-width="1" style="margin-bottom:16px;"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg><p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.4); margin-bottom:8px;">No subleases posted yet.</p><p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.3);">Be the first — tap "+ New Post" above.</p></div>';
    return;
  }
  let html = '<div style="border:1px solid rgba(26,26,26,0.08); border-radius:12px; overflow:hidden;">';
  posts.forEach((p, i) => {
    const realIndex = subleasePostsData.indexOf(p);
    const border = i < posts.length - 1 ? 'border-bottom:1px solid rgba(26,26,26,0.06);' : '';
    html += '<div style="padding:16px 20px; ' + border + ' position:relative;">';
    html += '<div style="display:flex; justify-content:space-between; align-items:flex-start;">';
    html += '<div style="flex:1;">';
    html += '<p class="font-body" style="font-weight:600; color:#1A1A1A;">' + p.title + (p.price ? ' — ' + p.price : '') + '</p>';
    html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4);">' + (p.dates || '') + ' · ' + p.time + '</p>';
    if (p.desc) html += '<p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.6); margin-top:6px;">' + p.desc + '</p>';
    if (p.email) html += '<a href="mailto:' + p.email + '?subject=Interested in your sublease: ' + encodeURIComponent(p.title) + '" class="font-body" style="font-size:12px; color:#FF8200; text-decoration:none; display:inline-flex; align-items:center; gap:4px; margin-top:6px; font-weight:500;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Contact: ' + p.email + '</a>';
    html += '</div>';
    html += '<button onclick="deleteSubleasePost(' + realIndex + ')" style="background:none; border:none; cursor:pointer; padding:4px 8px; color:rgba(26,26,26,0.3); font-size:18px; line-height:1; transition:color 0.2s;" onmouseover="this.style.color=\'#e53e3e\'" onmouseout="this.style.color=\'rgba(26,26,26,0.3)\'" title="Delete post">&times;</button>';
    html += '</div>';
    html += '</div>';
  });
  html += '</div>';
  container.innerHTML = html;
}
function filterSubleases() {
  const q = document.getElementById('sublease-search-input').value;
  renderSubleaseListings(q);
}

// ============================================
// ROOMMATE PROFILE
// ============================================
let savedRoommateProfile = null;
let rmMatches = JSON.parse(localStorage.getItem('smartlease_roommate_matches') || '[]');
let rmPassed = JSON.parse(localStorage.getItem('smartlease_roommate_passed') || '[]');
let rmCurrentFilter = '';
let rmCardQueue = [];
let rmCurrentCardIdx = 0;

const DEMO_ROOMMATES = [
  { name:'Sarah Mitchell', email:'smitch42@vols.utk.edu', gender:'Female', major:'Business Analytics', social:'@sarahm_utk', living:'Hub Knoxville', year:'Junior', bed:'2 Bed', budgetMin:1200, budgetMax:1600, moveIn:'Fall 2026', sleep:'Night owl', cleanliness:4, noise:3, guests:'Sometimes', study:'Both', tags:['Social','Drinks socially'], avatarColor:'#E8634A' },
  { name:'Jake Thompson', email:'jthomps8@vols.utk.edu', gender:'Male', major:'Computer Science', social:'@jake.codes', living:'The Standard at Knoxville', year:'Sophomore', bed:'2 Bed', budgetMin:1100, budgetMax:1500, moveIn:'Fall 2026', sleep:'Night owl', cleanliness:3, noise:4, guests:'Often', study:'At home', tags:['Social','No pets pls'], avatarColor:'#4A90D9' },
  { name:'Emily Chen', email:'echen12@vols.utk.edu', gender:'Female', major:'Pre-Med', social:'@em.chen', living:'The Knox Apartments', year:'Freshman', bed:'4 Bed', budgetMin:800, budgetMax:1000, moveIn:'Fall 2026', sleep:'Early bird', cleanliness:5, noise:2, guests:'Rarely', study:'Library', tags:['Quiet','No smoking','No alcohol'], avatarColor:'#7B68EE' },
  { name:'Marcus Johnson', email:'mjohns55@vols.utk.edu', gender:'Male', major:'Civil Engineering', social:'@marcusj_', living:'303 Flats', year:'Senior', bed:'2 Bed', budgetMin:1000, budgetMax:1300, moveIn:'Summer 2026', sleep:'Early bird', cleanliness:4, noise:2, guests:'Sometimes', study:'Library', tags:['No smoking','Has pets'], avatarColor:'#2E8B57' },
  { name:'Olivia Rodriguez', email:'orodri3@vols.utk.edu', gender:'Female', major:'Architecture', social:'@livdesigns', living:'The Mark', year:'Junior', bed:'3 Bed', budgetMin:900, budgetMax:1200, moveIn:'Fall 2026', sleep:'Night owl', cleanliness:3, noise:3, guests:'Often', study:'At home', tags:['Social','Drinks socially','Has pets'], avatarColor:'#FF6B81' },
  { name:'Tyler Brooks', email:'tbrooks7@vols.utk.edu', gender:'Male', major:'Finance', social:'@tylerb.finance', living:'Ever', year:'Senior', bed:'4 Bed', budgetMin:1200, budgetMax:1500, moveIn:'Fall 2026', sleep:'Flexible', cleanliness:3, noise:4, guests:'Often', study:'Both', tags:['Social','Drinks socially','Smokes socially'], avatarColor:'#D4A03C' },
  { name:'Aisha Patel', email:'apatel29@vols.utk.edu', gender:'Female', major:'Nursing', social:'@aisha.rn', living:'', year:'Sophomore', bed:'2 Bed', budgetMin:800, budgetMax:1100, moveIn:'Fall 2026', sleep:'Early bird', cleanliness:5, noise:1, guests:'Rarely', study:'Library', tags:['Quiet','No smoking','No alcohol','No pets pls'], avatarColor:'#20B2AA' },
  { name:'Chris Martinez', email:'cmart16@vols.utk.edu', gender:'Male', major:'Sports Management', social:'@chris.m.utk', living:'Slate at 901', year:'Junior', bed:'3 Bed', budgetMin:1100, budgetMax:1600, moveIn:'Summer 2026', sleep:'Night owl', cleanliness:2, noise:5, guests:'Often', study:'Both', tags:['Social','Drinks socially','Smokes socially'], avatarColor:'#FF8C00' },
  { name:'Hannah Lee', email:'hlee44@vols.utk.edu', gender:'Female', major:'Graphic Design', social:'@hannahcreates', living:'The Davy', year:'Freshman', bed:'2 Bed', budgetMin:900, budgetMax:1400, moveIn:'Fall 2026', sleep:'Night owl', cleanliness:4, noise:3, guests:'Sometimes', study:'At home', tags:['Has pets','Social'], avatarColor:'#C71585' },
  { name:'Daniel Kim', email:'dkim33@vols.utk.edu', gender:'Male', major:'Accounting', social:'@dan.kim', living:'University Walk', year:'Senior', bed:'3 Bed', budgetMin:800, budgetMax:1100, moveIn:'ASAP', sleep:'Early bird', cleanliness:4, noise:2, guests:'Rarely', study:'Library', tags:['Quiet','No smoking'], avatarColor:'#4682B4' },
  { name:'Jasmine Wright', email:'jwrigh9@vols.utk.edu', gender:'Female', major:'Psychology', social:'@jas.wright', living:'Villas Knoxville', year:'Junior', bed:'4 Bed', budgetMin:900, budgetMax:1100, moveIn:'Fall 2026', sleep:'Flexible', cleanliness:3, noise:3, guests:'Sometimes', study:'Both', tags:['Has pets','Social','Drinks socially'], avatarColor:'#DA70D6' },
  { name:"Ryan O'Brien", email:'robrien5@vols.utk.edu', gender:'Male', major:'Mechanical Engineering', social:'@ryanobrien', living:'The Heights', year:'Sophomore', bed:'3 Bed', budgetMin:700, budgetMax:1000, moveIn:'Fall 2026', sleep:'Night owl', cleanliness:3, noise:4, guests:'Sometimes', study:'At home', tags:['Social','Smokes socially'], avatarColor:'#708090' },
  { name:'Sofia Garcia', email:'sgarci7@vols.utk.edu', gender:'Female', major:'Marketing', social:'@sofi.garcia', living:'The Commons at Knoxville', year:'Freshman', bed:'2 Bed', budgetMin:800, budgetMax:1100, moveIn:'Fall 2026', sleep:'Early bird', cleanliness:4, noise:2, guests:'Rarely', study:'Library', tags:['Quiet','No alcohol','No pets pls'], avatarColor:'#F08080' },
  { name:'Ethan Wilson', email:'ewilso22@vols.utk.edu', gender:'Male', major:'Political Science', social:'@ethan.w', living:'TENN', year:'Senior', bed:'4 Bed', budgetMin:1200, budgetMax:1500, moveIn:'Summer 2026', sleep:'Flexible', cleanliness:3, noise:3, guests:'Often', study:'Both', tags:['Social','Drinks socially'], avatarColor:'#6A5ACD' },
  { name:'Mia Anderson', email:'mander8@vols.utk.edu', gender:'Female', major:'Biology', social:'@mia.bio', living:'Tradition at Knoxville', year:'Sophomore', bed:'2 Bed', budgetMin:700, budgetMax:900, moveIn:'Fall 2026', sleep:'Early bird', cleanliness:5, noise:1, guests:'Rarely', study:'Library', tags:['Quiet','No smoking','No alcohol'], avatarColor:'#3CB371' },
  { name:'Noah Davis', email:'ndavis18@vols.utk.edu', gender:'Male', major:'Supply Chain', social:'@noah.d', living:'Knox Ridge', year:'Junior', bed:'4 Bed', budgetMin:800, budgetMax:1100, moveIn:'Fall 2026', sleep:'Night owl', cleanliness:2, noise:4, guests:'Often', study:'At home', tags:['Has pets','Smokes socially','Social'], avatarColor:'#B8860B' },
  { name:'Lily Nguyen', email:'lnguye5@vols.utk.edu', gender:'Non-binary', major:'Communication Studies', social:'@lily.ng', living:'Livano', year:'Freshman', bed:'Studio', budgetMin:1000, budgetMax:1400, moveIn:'Spring 2027', sleep:'Flexible', cleanliness:4, noise:3, guests:'Sometimes', study:'Both', tags:['Social','Drinks socially','No pets pls'], avatarColor:'#DB7093' },
  { name:'Brandon Scott', email:'bscott31@vols.utk.edu', gender:'Male', major:'Kinesiology', social:'@b.scott.fit', living:'The Woodlands', year:'Senior', bed:'3 Bed', budgetMin:600, budgetMax:850, moveIn:'ASAP', sleep:'Early bird', cleanliness:4, noise:2, guests:'Sometimes', study:'Both', tags:['No smoking','Has pets'], avatarColor:'#228B22' },
];

function toggleRmTag(el) {
  el.classList.toggle('selected');
  if (el.classList.contains('selected')) {
    el.style.background = '#FF8200';
    el.style.color = 'white';
    el.style.borderColor = '#FF8200';
  } else {
    el.style.background = 'transparent';
    el.style.color = '#1A1A1A';
    el.style.borderColor = 'rgba(26,26,26,0.12)';
  }
}

function selectRmRadio(el) {
  const group = el.getAttribute('data-group');
  document.querySelectorAll('.rm-radio[data-group="' + group + '"]').forEach(sib => {
    sib.classList.remove('selected');
    sib.style.background = 'transparent';
    sib.style.color = '#1A1A1A';
    sib.style.borderColor = 'rgba(26,26,26,0.12)';
  });
  el.classList.add('selected');
  el.style.background = '#FF8200';
  el.style.color = 'white';
  el.style.borderColor = '#FF8200';
}

function getSelectedRadio(group) {
  const el = document.querySelector('.rm-radio[data-group="' + group + '"].selected');
  return el ? el.textContent.trim() : null;
}

function populateRoommateLiving() {
  const sel = document.getElementById('rm-living');
  if (!sel) return;
  const names = APARTMENTS_DATA.map(a => a.name).sort();
  sel.innerHTML = '<option value="">Not decided yet</option>' + names.map(n => '<option value="' + n + '">' + n + '</option>').join('');
}
function showRoommateProfileForm() {
  document.getElementById('roommate-setup').style.display = 'none';
  document.getElementById('roommate-form').style.display = 'block';
  const u = JSON.parse(localStorage.getItem('smartlease_user') || '{}');
  const emailEl = document.getElementById('rm-email');
  if (u.email && emailEl && !emailEl.value) emailEl.value = u.email;
  if (u.name && !document.getElementById('rm-name').value) document.getElementById('rm-name').value = u.name;
}

function collectRoommateProfile() {
  const name = document.getElementById('rm-name').value.trim();
  const email = document.getElementById('rm-email').value.trim();
  const major = document.getElementById('rm-major').value.trim();
  const social = document.getElementById('rm-social').value.trim();
  const gender = getSelectedRadio('gender');
  const living = document.getElementById('rm-living').value;
  const year = getSelectedRadio('year');
  const bed = getSelectedRadio('bed');
  const budgetMin = parseInt(document.getElementById('rm-budget-min').value) || 0;
  const budgetMax = parseInt(document.getElementById('rm-budget-max').value) || 0;
  const moveIn = getSelectedRadio('movein');
  const sleep = getSelectedRadio('sleep');
  const cleanliness = parseInt(document.getElementById('rm-cleanliness').value);
  const noise = parseInt(document.getElementById('rm-noise').value);
  const guests = getSelectedRadio('guests');
  const study = getSelectedRadio('study');
  const tags = [];
  document.querySelectorAll('#roommate-form .rm-tag.selected').forEach(t => tags.push(t.textContent.trim()));
  return { name, email, gender, major, social, living, year, bed, budgetMin, budgetMax, moveIn, sleep, cleanliness, noise, guests, study, tags };
}

function renderProfileSummary(profile) {
  const el = document.getElementById('rm-profile-summary');
  const row = (label, value) => value ? '<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(26,26,26,0.04);"><span class="font-body" style="font-size:12px; color:rgba(26,26,26,0.45);">' + label + '</span><span class="font-body" style="font-size:12px; color:#1A1A1A; font-weight:500;">' + value + '</span></div>' : '';

  let html = '<div style="display:flex; align-items:center; gap:14px; margin-bottom:16px;">';
  html += '<div style="width:44px; height:44px; border-radius:50%; background:#FF8200; display:flex; align-items:center; justify-content:center;"><span class="font-editorial" style="color:white; font-size:16px;">' + (profile.name ? profile.name.charAt(0).toUpperCase() : '?') + '</span></div>';
  html += '<div><p class="font-body" style="font-size:15px; font-weight:600; color:#1A1A1A;">' + (profile.name || 'Anonymous') + '</p>';
  if (profile.major) html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4);">' + profile.major + (profile.year ? ' · ' + profile.year : '') + '</p>';
  html += '</div></div>';

  if (profile.email) html += row('Email', profile.email);
  if (profile.gender) html += row('Gender', profile.gender);
  if (profile.living) html += row('Living at', profile.living);
  html += row('Bedroom', profile.bed);
  html += row('Budget', profile.budgetMin && profile.budgetMax ? '$' + profile.budgetMin + ' – $' + profile.budgetMax : profile.budgetMin ? '$' + profile.budgetMin + '+' : null);
  html += row('Move-in', profile.moveIn);
  html += row('Sleep', profile.sleep);
  html += row('Cleanliness', profile.cleanliness + ' / 5');
  html += row('Noise tolerance', profile.noise + ' / 5');
  html += row('Guests', profile.guests);
  html += row('Study', profile.study);
  if (profile.social) html += row('Social', profile.social);

  if (profile.tags.length > 0) {
    html += '<div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:6px;">';
    profile.tags.forEach(t => {
      html += '<span class="font-body" style="font-size:11px; padding:4px 12px; border-radius:20px; background:rgba(255,130,0,0.08); color:#FF8200;">' + t + '</span>';
    });
    html += '</div>';
  }

  el.innerHTML = html;
}

function submitRoommateProfile() {
  const profile = collectRoommateProfile();
  if (!profile.name) { document.getElementById('rm-name').focus(); return; }
  if (!profile.email || !profile.email.includes('@')) { document.getElementById('rm-email').focus(); return; }
  savedRoommateProfile = profile;
  renderProfileSummary(profile);
  document.getElementById('roommate-form').style.display = 'none';
  document.getElementById('roommate-matching').style.display = 'block';
  initRoommateSwipe();
}

function editRoommateProfile() {
  if (savedRoommateProfile) {
    const p = savedRoommateProfile;
    document.getElementById('rm-name').value = p.name || '';
    document.getElementById('rm-email').value = p.email || '';
    document.getElementById('rm-major').value = p.major || '';
    document.getElementById('rm-social').value = p.social || '';
    document.getElementById('rm-living').value = p.living || '';
    if (p.budgetMin) document.getElementById('rm-budget-min').value = p.budgetMin;
    if (p.budgetMax) document.getElementById('rm-budget-max').value = p.budgetMax;
    document.getElementById('rm-cleanliness').value = p.cleanliness || 3;
    document.getElementById('rm-clean-val').textContent = p.cleanliness || 3;
    document.getElementById('rm-noise').value = p.noise || 3;
    document.getElementById('rm-noise-val').textContent = p.noise || 3;
    ['gender','year','bed','sleep','movein','guests','study'].forEach(group => {
      document.querySelectorAll('.rm-radio[data-group="' + group + '"]').forEach(el => {
        el.classList.remove('selected');
        el.style.background = 'transparent';
        el.style.color = '#1A1A1A';
        el.style.borderColor = 'rgba(26,26,26,0.12)';
      });
      const val = group === 'movein' ? p.moveIn : group === 'gender' ? p.gender : p[group];
      if (val) {
        document.querySelectorAll('.rm-radio[data-group="' + group + '"]').forEach(el => {
          if (el.textContent.trim() === val) {
            el.classList.add('selected');
            el.style.background = '#FF8200';
            el.style.color = 'white';
            el.style.borderColor = '#FF8200';
          }
        });
      }
    });
    document.querySelectorAll('#roommate-form .rm-tag').forEach(el => {
      const txt = el.textContent.trim();
      if (p.tags && p.tags.includes(txt)) {
        el.classList.add('selected');
        el.style.background = '#FF8200';
        el.style.color = 'white';
        el.style.borderColor = '#FF8200';
      } else {
        el.classList.remove('selected');
        el.style.background = 'transparent';
        el.style.color = '#1A1A1A';
        el.style.borderColor = 'rgba(26,26,26,0.12)';
      }
    });
  }
  document.getElementById('roommate-matching').style.display = 'none';
  document.getElementById('roommate-form').style.display = 'block';
}

// ============================================
// ROOMMATE COMPATIBILITY ALGORITHM
// ============================================
function computeCompatibility(a, b) {
  let score = 0;

  // Budget overlap (20 pts)
  if (a.budgetMin && a.budgetMax && b.budgetMin && b.budgetMax) {
    const overlapStart = Math.max(a.budgetMin, b.budgetMin);
    const overlapEnd = Math.min(a.budgetMax, b.budgetMax);
    if (overlapEnd >= overlapStart) {
      const overlapRange = overlapEnd - overlapStart;
      const totalRange = Math.max(a.budgetMax, b.budgetMax) - Math.min(a.budgetMin, b.budgetMin);
      score += totalRange > 0 ? Math.round((overlapRange / totalRange) * 20) : 20;
    }
  } else {
    score += 10;
  }

  // Sleep schedule (15 pts)
  if (a.sleep && b.sleep) {
    if (a.sleep === b.sleep) score += 15;
    else if (a.sleep === 'Flexible' || b.sleep === 'Flexible') score += 10;
  } else {
    score += 7;
  }

  // Cleanliness proximity (15 pts)
  const cleanDiff = Math.abs((a.cleanliness || 3) - (b.cleanliness || 3));
  score += Math.round((1 - cleanDiff / 4) * 15);

  // Noise tolerance proximity (10 pts)
  const noiseDiff = Math.abs((a.noise || 3) - (b.noise || 3));
  score += Math.round((1 - noiseDiff / 4) * 10);

  // Pet compatibility (10 pts)
  const aPets = a.tags || [];
  const bPets = b.tags || [];
  const aHas = aPets.includes('Has pets');
  const aNo = aPets.includes('No pets pls');
  const bHas = bPets.includes('Has pets');
  const bNo = bPets.includes('No pets pls');
  if ((aHas && bNo) || (bHas && aNo)) {
    score += 0;
  } else if ((aHas && bHas) || (aNo && bNo)) {
    score += 10;
  } else {
    score += 6;
  }

  // Guest frequency (10 pts)
  if (a.guests && b.guests) {
    const gMap = { 'Rarely': 0, 'Sometimes': 1, 'Often': 2 };
    const gDiff = Math.abs((gMap[a.guests] || 1) - (gMap[b.guests] || 1));
    score += gDiff === 0 ? 10 : gDiff === 1 ? 6 : 2;
  } else {
    score += 5;
  }

  // Study habits (10 pts)
  if (a.study && b.study) {
    if (a.study === b.study) score += 10;
    else if (a.study === 'Both' || b.study === 'Both') score += 7;
    else score += 3;
  } else {
    score += 5;
  }

  // Move-in date proximity (10 pts)
  if (a.moveIn && b.moveIn) {
    const mOrder = ['ASAP', 'Summer 2026', 'Fall 2026', 'Spring 2027'];
    const diff = Math.abs(mOrder.indexOf(a.moveIn) - mOrder.indexOf(b.moveIn));
    score += diff === 0 ? 10 : diff === 1 ? 6 : 2;
  } else {
    score += 5;
  }

  // Same apartment bonus (bonus 10 pts, doesn't replace existing)
  if (a.living && b.living && a.living === b.living && a.living !== '') {
    score += 10;
  }

  return Math.min(100, Math.max(0, score));
}

// ============================================
// ROOMMATE SWIPE / MATCHING ENGINE
// ============================================
function initRoommateSwipe() {
  buildRmFilterBar();
  buildRmCardQueue();
  renderRmCards();
  updateRmMatchCount();
}

function buildRmFilterBar() {
  const bar = document.getElementById('rm-filter-bar');
  if (!bar) return;
  const apartments = APARTMENTS_DATA.map(a => a.name).sort();
  let html = '<button class="rm-filter-pill active" onclick="setRmFilter(\'\')">Everyone</button>';
  apartments.forEach(name => {
    html += '<button class="rm-filter-pill" onclick="setRmFilter(\'' + name.replace(/'/g, "\\'") + '\')">' + name + '</button>';
  });
  bar.innerHTML = html;
}

function setRmFilter(apartment) {
  rmCurrentFilter = apartment;
  document.querySelectorAll('.rm-filter-pill').forEach(p => {
    const isActive = apartment === '' ? p.textContent === 'Everyone' : p.textContent === apartment;
    p.classList.toggle('active', isActive);
  });
  buildRmCardQueue();
  renderRmCards();
}

function buildRmCardQueue() {
  if (!savedRoommateProfile) return;
  const matchedNames = rmMatches.map(m => m.name);
  let pool = DEMO_ROOMMATES.filter(p =>
    !matchedNames.includes(p.name) && !rmPassed.includes(p.name)
  );
  if (rmCurrentFilter) {
    pool = pool.filter(p => p.living === rmCurrentFilter);
  }
  pool.forEach(p => {
    p._compat = computeCompatibility(savedRoommateProfile, p);
  });
  pool.sort((a, b) => b._compat - a._compat);
  rmCardQueue = pool;
  rmCurrentCardIdx = 0;
}

function renderRmCards() {
  const stack = document.getElementById('rm-card-stack');
  const btns = document.getElementById('rm-swipe-btns');
  if (!stack) return;

  if (rmCurrentCardIdx >= rmCardQueue.length) {
    stack.innerHTML = '<div class="rm-empty-state">' +
      '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.15)" stroke-width="1" style="margin-bottom:16px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' +
      '<p class="font-editorial" style="font-size:20px; color:#1A1A1A; margin-bottom:6px;">You\'ve seen everyone!</p>' +
      '<p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.4); line-height:1.6; margin-bottom:20px;">Check back as more UT students join SmartLease.</p>' +
      (rmMatches.length > 0 ? '<button class="btn btn-primary" style="margin-bottom:10px;" onclick="switchRmTab(\'matches\')">View Your Matches (' + rmMatches.length + ')</button>' : '') +
      '<button class="btn btn-ghost" onclick="resetRmPassed()">Browse Again</button>' +
      '</div>';
    if (btns) btns.style.display = 'none';
    return;
  }

  if (btns) btns.style.display = 'flex';
  let html = '';
  const visibleCount = Math.min(3, rmCardQueue.length - rmCurrentCardIdx);
  for (let i = visibleCount - 1; i >= 0; i--) {
    const p = rmCardQueue[rmCurrentCardIdx + i];
    const zClass = i === 0 ? '' : i === 1 ? 'behind' : 'far-behind';
    html += buildRmCardHTML(p, zClass, i === 0);
  }
  stack.innerHTML = html;

  if (visibleCount > 0) {
    const topCard = stack.querySelector('.rm-card:not(.behind):not(.far-behind)');
    if (topCard) initCardSwipeGesture(topCard);
  }
}

function buildRmCardHTML(profile, extraClass, isTop) {
  const compat = profile._compat || 0;
  const budgetStr = profile.budgetMin && profile.budgetMax ? '$' + profile.budgetMin + ' – $' + profile.budgetMax : '';
  let html = '<div class="rm-card ' + extraClass + '" data-name="' + profile.name.replace(/"/g, '&quot;') + '">';
  html += '<div class="rm-card-header">';
  html += '<div class="rm-avatar" style="background:' + (profile.avatarColor || '#FF8200') + '"><span>' + profile.name.charAt(0) + '</span></div>';
  html += '<div><p class="font-body" style="font-size:17px; font-weight:600; color:#1A1A1A;">' + profile.name + '</p>';
  html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4);">' + (profile.major || '') + (profile.year ? ' · ' + profile.year : '') + (profile.gender ? ' · ' + profile.gender : '') + '</p></div>';
  html += '<div class="rm-compat-badge">' + compat + '%</div>';
  html += '</div>';
  html += '<div class="rm-card-body">';
  if (profile.living) html += '<div class="rm-trait-row"><span class="label">Living at</span><span class="value">' + profile.living + '</span></div>';
  if (profile.bed) html += '<div class="rm-trait-row"><span class="label">Bedroom</span><span class="value">' + profile.bed + '</span></div>';
  if (budgetStr) html += '<div class="rm-trait-row"><span class="label">Budget</span><span class="value">' + budgetStr + '</span></div>';
  if (profile.moveIn) html += '<div class="rm-trait-row"><span class="label">Move-in</span><span class="value">' + profile.moveIn + '</span></div>';
  if (profile.sleep) html += '<div class="rm-trait-row"><span class="label">Sleep</span><span class="value">' + profile.sleep + '</span></div>';
  html += '<div class="rm-trait-row"><span class="label">Cleanliness</span><span class="value">' + (profile.cleanliness || 3) + ' / 5</span></div>';
  html += '<div class="rm-trait-row"><span class="label">Noise</span><span class="value">' + (profile.noise || 3) + ' / 5</span></div>';
  if (profile.guests) html += '<div class="rm-trait-row"><span class="label">Guests</span><span class="value">' + profile.guests + '</span></div>';
  if (profile.study) html += '<div class="rm-trait-row"><span class="label">Study</span><span class="value">' + profile.study + '</span></div>';
  if (profile.social) html += '<div class="rm-trait-row"><span class="label">Social</span><span class="value">' + profile.social + '</span></div>';
  if (profile.tags && profile.tags.length) {
    html += '<div class="rm-card-tags">';
    profile.tags.forEach(t => { html += '<span>' + t + '</span>'; });
    html += '</div>';
  }
  html += '</div></div>';
  return html;
}

function initCardSwipeGesture(card) {
  let startX = 0, startY = 0, currentX = 0, isDragging = false;
  const onStart = (e) => {
    isDragging = true;
    const touch = e.touches ? e.touches[0] : e;
    startX = touch.clientX;
    startY = touch.clientY;
    card.style.transition = 'none';
  };
  const onMove = (e) => {
    if (!isDragging) return;
    const touch = e.touches ? e.touches[0] : e;
    currentX = touch.clientX - startX;
    const rotate = currentX * 0.08;
    card.style.transform = 'translateX(' + currentX + 'px) rotate(' + rotate + 'deg)';
    card.style.opacity = Math.max(0.5, 1 - Math.abs(currentX) / 400);
  };
  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    const threshold = 100;
    if (Math.abs(currentX) > threshold) {
      const direction = currentX > 0 ? 'right' : 'left';
      animateSwipe(card, direction);
    } else {
      card.style.transition = 'transform 0.3s, opacity 0.3s';
      card.style.transform = 'translateX(0) rotate(0)';
      card.style.opacity = '1';
    }
    currentX = 0;
  };
  card.addEventListener('mousedown', onStart);
  card.addEventListener('mousemove', onMove);
  card.addEventListener('mouseup', onEnd);
  card.addEventListener('mouseleave', onEnd);
  card.addEventListener('touchstart', onStart, { passive: true });
  card.addEventListener('touchmove', onMove, { passive: true });
  card.addEventListener('touchend', onEnd);
}

function triggerSwipe(direction) {
  const stack = document.getElementById('rm-card-stack');
  const topCard = stack ? stack.querySelector('.rm-card:not(.behind):not(.far-behind)') : null;
  if (topCard) animateSwipe(topCard, direction);
}

function animateSwipe(card, direction) {
  const animName = direction === 'right' ? 'rmFlyRight' : 'rmFlyLeft';
  card.style.transition = 'none';
  card.style.animation = animName + ' 0.4s ease forwards';
  const profileName = card.getAttribute('data-name');
  const profile = rmCardQueue[rmCurrentCardIdx];
  setTimeout(() => {
    if (direction === 'right' && profile) {
      handleRmMatch(profile);
    } else if (profile) {
      handleRmPass(profile);
    }
    rmCurrentCardIdx++;
    renderRmCards();
  }, 350);
}

function handleRmMatch(profile) {
  const matchObj = {
    name: profile.name,
    email: profile.email,
    gender: profile.gender,
    major: profile.major,
    year: profile.year,
    social: profile.social,
    living: profile.living,
    avatarColor: profile.avatarColor,
    compat: profile._compat || 0,
  };
  rmMatches.push(matchObj);
  localStorage.setItem('smartlease_roommate_matches', JSON.stringify(rmMatches));
  updateRmMatchCount();
  showMatchFlash(profile.name);
}

function handleRmPass(profile) {
  rmPassed.push(profile.name);
  localStorage.setItem('smartlease_roommate_passed', JSON.stringify(rmPassed));
}

function showMatchFlash(name) {
  const flash = document.getElementById('rm-match-flash');
  const text = document.getElementById('rm-match-flash-text');
  if (!flash) return;
  if (text) text.textContent = 'You and ' + name.split(' ')[0] + ' are a great fit.';
  flash.classList.add('show');
  setTimeout(() => { flash.classList.remove('show'); }, 1800);
}

function switchRmTab(tab) {
  const discoverTab = document.getElementById('rm-discover-tab');
  const matchesTab = document.getElementById('rm-matches-tab');
  const tabBtns = document.querySelectorAll('.rm-tab-bar button');
  tabBtns.forEach((btn, i) => {
    btn.classList.toggle('active', (tab === 'discover' && i === 0) || (tab === 'matches' && i === 1));
  });
  if (tab === 'discover') {
    if (discoverTab) discoverTab.style.display = 'block';
    if (matchesTab) matchesTab.style.display = 'none';
  } else {
    if (discoverTab) discoverTab.style.display = 'none';
    if (matchesTab) matchesTab.style.display = 'block';
    renderRmMatchesList();
  }
}

function renderRmMatchesList() {
  const container = document.getElementById('rm-matches-tab');
  if (!container) return;

  if (rmMatches.length === 0) {
    container.innerHTML = '<div class="rm-empty-state">' +
      '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.15)" stroke-width="1" style="margin-bottom:16px;"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>' +
      '<p class="font-editorial" style="font-size:18px; color:#1A1A1A; margin-bottom:6px;">No matches yet</p>' +
      '<p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.4); line-height:1.6;">Swipe right on profiles you like to start matching.</p>' +
      '</div>';
    return;
  }

  let html = '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:16px;">' + rmMatches.length + ' match' + (rmMatches.length !== 1 ? 'es' : '') + '</p>';
  rmMatches.forEach((m, i) => {
    html += '<div class="rm-match-card">';
    html += '<div class="rm-match-card-header">';
    html += '<div class="rm-match-avatar" style="background:' + (m.avatarColor || '#FF8200') + '"><span>' + m.name.charAt(0) + '</span></div>';
    html += '<div class="rm-match-info">';
    html += '<p class="font-body" style="font-size:15px; font-weight:600; color:#1A1A1A;">' + m.name + '</p>';
    html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4);">' + (m.major || '') + (m.year ? ' · ' + m.year : '') + (m.gender ? ' · ' + m.gender : '') + '</p>';
    html += '</div>';
    html += '<div class="rm-compat-badge" style="position:static; width:40px; height:40px; font-size:11px;">' + m.compat + '%</div>';
    html += '</div>';
    if (m.living) html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:4px;">Lives at <span style="color:#1A1A1A; font-weight:500;">' + m.living + '</span></p>';
    if (m.social) html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-bottom:4px;">Social: <span style="color:#1A1A1A; font-weight:500;">' + m.social + '</span></p>';
    html += '<div class="rm-match-actions">';
    html += '<a href="mailto:' + m.email + '" class="btn btn-primary" style="flex:1; text-align:center; text-decoration:none; display:flex; align-items:center; justify-content:center; gap:6px;">';
    html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>';
    html += 'Email ' + m.name.split(' ')[0] + '</a>';
    html += '<button class="btn btn-ghost" style="padding:8px 14px; color:#FF4458;" onclick="removeRmMatch(' + i + ')">Remove</button>';
    html += '</div></div>';
  });
  container.innerHTML = html;
}

function removeRmMatch(index) {
  const removed = rmMatches.splice(index, 1);
  if (removed.length) {
    const name = removed[0].name;
    rmPassed = rmPassed.filter(n => n !== name);
    localStorage.setItem('smartlease_roommate_passed', JSON.stringify(rmPassed));
  }
  localStorage.setItem('smartlease_roommate_matches', JSON.stringify(rmMatches));
  updateRmMatchCount();
  renderRmMatchesList();
  buildRmCardQueue();
}

function updateRmMatchCount() {
  const el = document.getElementById('rm-match-count');
  if (el) el.textContent = rmMatches.length > 0 ? '(' + rmMatches.length + ')' : '';
}

function resetRmPassed() {
  rmPassed = [];
  localStorage.removeItem('smartlease_roommate_passed');
  buildRmCardQueue();
  renderRmCards();
}

// ============================================
// REVIEWS
// ============================================
let userReviews = [];
let reviewStarsValue = 0;
function populateReviewDropdowns() {
  const propSel = document.getElementById('review-property');
  const filterSel = document.getElementById('review-filter-property');
  const names = APARTMENTS_DATA.map(a => a.name).sort();
  if (propSel) propSel.innerHTML = '<option value="">Select a property</option>' + names.map(n => '<option value="' + n + '">' + n + '</option>').join('');
  if (filterSel) filterSel.innerHTML = '<option value="">All apartments</option>' + names.map(n => '<option value="' + n + '">' + n + '</option>').join('');
}
function setReviewStars(n) {
  reviewStarsValue = n;
  const stars = document.querySelectorAll('#review-stars-input .star');
  stars.forEach((s, i) => { s.style.opacity = i < n ? '1' : '0.3'; });
}
function toggleReviewForm() {
  const form = document.getElementById('review-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}
function submitReview() {
  const property = document.getElementById('review-property').value;
  const text = document.getElementById('review-text').value.trim();
  const author = document.getElementById('review-author').value.trim();
  if (!property || !text || !author || !reviewStarsValue) return;
  userReviews.push({ property, stars: reviewStarsValue, text, author, time: 'Just now' });
  document.getElementById('review-property').value = '';
  document.getElementById('review-text').value = '';
  document.getElementById('review-author').value = '';
  setReviewStars(0);
  toggleReviewForm();
  renderUserReviews();
}
function deleteReview(index) {
  userReviews.splice(index, 1);
  renderUserReviews();
}
function renderUserReviews() {
  const container = document.getElementById('reviews-list');
  const filterSel = document.getElementById('review-filter-property');
  const filterVal = filterSel ? filterSel.value : '';
  const reviews = filterVal ? userReviews.filter(r => r.property === filterVal) : userReviews;
  if (reviews.length === 0) {
    container.innerHTML = '<div style="padding:48px 24px; text-align:center; border:1px dashed rgba(26,26,26,0.1); border-radius:12px;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(26,26,26,0.15)" stroke-width="1" style="margin-bottom:16px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.4); margin-bottom:8px;">No reviews yet.</p><p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.3);">Be the first to share your experience.</p></div>';
    return;
  }
  let html = '<div style="border:1px solid rgba(26,26,26,0.08); border-radius:12px; overflow:hidden;">';
  reviews.forEach((r, i) => {
    const realIndex = userReviews.indexOf(r);
    const border = i < reviews.length - 1 ? 'border-bottom:1px solid rgba(26,26,26,0.06);' : '';
    const starsStr = '★'.repeat(r.stars) + '☆'.repeat(5 - r.stars);
    html += '<div style="padding:20px; ' + border + '">';
    html += '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">';
    html += '<div class="star">' + starsStr + '</div>';
    html += '<div style="display:flex; align-items:center; gap:8px;">';
    html += '<span class="font-body" style="font-size:11px; color:#00b464;">Verified</span>';
    html += '<button onclick="deleteReview(' + realIndex + ')" style="background:none; border:none; cursor:pointer; padding:2px 6px; color:rgba(26,26,26,0.3); font-size:16px; line-height:1; transition:color 0.2s;" onmouseover="this.style.color=\'#e53e3e\'" onmouseout="this.style.color=\'rgba(26,26,26,0.3)\'" title="Delete review">&times;</button>';
    html += '</div></div>';
    html += '<p class="font-editorial" style="font-size:15px; font-style:italic; color:#1A1A1A; line-height:1.6;">"' + r.text + '"</p>';
    html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.4); margin-top:8px;">— ' + r.author + ', ' + r.property + ' · ' + r.time + '</p>';
    html += '</div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

// ============================================
// INTERACTIVE MAP (Leaflet / OpenStreetMap)
// ============================================
let leafletMap = null;
let mapMarkersLayer = null;
const APT_COORDS = [
  [35.9560, -83.9300], // Hub Knoxville — 1915 Cumberland Ave
  [35.9530, -83.9350], // University Walk — 2308 Forest Ave
  [35.9595, -83.9300], // The Knox Apartments — 1511 Clinch Ave
  [35.9555, -83.9320], // The Standard — 705 S 17th St
  [35.9470, -83.9265], // Villas Knoxville — 1440 Cityside Ln (South Waterfront)
  [35.9548, -83.9350], // The Commons — 200 19th St
  [35.9585, -83.9340], // Slate at 901 — 901 Mountcastle St (Fort Sanders)
  [35.9565, -83.9280], // TENN — 1830 Cumberland Ave
  [35.9578, -83.9455], // Tradition — 2521 Kingston Pike
  [35.9490, -83.9230], // 303 Flats — 303 W Blount Ave (South Waterfront)
  [35.9488, -83.9175], // The Davy — 222 E Blount Ave (South Waterfront)
  [35.9415, -83.9205], // The Heights — 1319 Knotty Pine Way (South Knoxville)
  [35.9370, -83.9250], // Knox Ridge — 2371 Cherokee Ridge Way (South Knoxville)
  [35.9340, -83.9310], // The Woodlands — 3805 Cherokee Woods Way (South Knoxville)
  [35.9585, -83.9370], // The Mark — 124 S Concord St
  [35.9540, -83.9270], // Ever — 1919 Lake Ave (near Sorority Village)
  [35.9490, -83.9255], // Livano — 465 W Blount Ave (South Waterfront)
  [35.9440, -83.9185], // Flagship Kerns — 2230 Chapman Hwy (South Knoxville)
  [35.9555, -83.9365], // Nova Knoxville — 2223 Cumberland Ave
  [35.9270, -83.9245], // Quarry Trail — 3999 Highland Crest Way (far south)
  [35.9541, -83.9388], // Union Knoxville — 2136 Cumberland Ave
];
function buildMapMarkers() {
  if (mapMarkersLayer) mapMarkersLayer.clearLayers();
  else mapMarkersLayer = L.layerGroup().addTo(leafletMap);
  APARTMENTS_DATA.forEach((apt, i) => {
    const coords = APT_COORDS[i] || [35.9544 + (Math.random() - 0.5) * 0.01, -83.9295 + (Math.random() - 0.5) * 0.01];
    const price = resolvePrice(apt);
    const hasBed = selectedBedroom ? !!findBestBedKey(apt, selectedBedroom) : true;
    const allOut = isAllSoldOut(apt);
    const resolvedMapKey = findBestBedKey(apt, selectedBedroom);
    const bedOut = resolvedMapKey && isSoldOut(apt, resolvedMapKey);
    const pinColor = allOut ? '#999' : bedOut ? '#d69e2e' : hasBed ? '#FF8200' : '#aaa';
    const pinOpacity = allOut ? 0.5 : 0.9;
    const marker = L.circleMarker(coords, { radius: 9, fillColor: pinColor, color: '#fff', weight: 2, fillOpacity: pinOpacity }).addTo(mapMarkersLayer);

    let statusNote = '';
    if (allOut) statusNote = '<p style="font-size:11px; color:#e53e3e; margin:0 0 6px; font-weight:600;">All plans sold out</p>';
    else if (bedOut) statusNote = '<p style="font-size:11px; color:#d69e2e; margin:0 0 6px; font-style:italic;">' + selectedBedroom + ' sold out — showing ' + resolveBedLabel(apt) + ' price</p>';
    else if (!hasBed) statusNote = '<p style="font-size:11px; color:#999; margin:0 0 6px; font-style:italic;">No ' + selectedBedroom + ' available — showing ' + apt.bedrooms + ' price</p>';

    const priceColor = allOut ? '#999' : '#FF8200';
    const priceText = allOut ? '<s>$' + price.toLocaleString() + '</s>' : '$' + price.toLocaleString() + '/mo';

    marker.bindPopup(
      '<div style="font-family:\'Space Grotesk\',sans-serif; min-width:160px;">' +
      '<p style="font-size:15px; font-weight:600; margin:0 0 4px;">' + apt.name + '</p>' +
      '<p style="font-size:14px; color:' + priceColor + '; font-weight:500; margin:0 0 4px;">' + priceText + (selectedBedroom && !allOut ? ' <span style="font-size:11px;color:#666;">(' + resolveBedLabel(apt) + ')</span>' : '') + '</p>' +
      '<p style="font-size:12px; color:#666; margin:0 0 4px;">' + apt.distanceMi + ' mi · ' + apt.amenities.slice(0, 3).join(', ') + '</p>' +
      (apt.parking ? '<p style="font-size:11px; color:#555; margin:0 0 4px;"><strong>Parking:</strong> ' + apt.parking + '</p>' : '') +
      (apt.special ? '<p style="font-size:11px; color:#00b464; margin:0 0 4px; font-weight:500;">✦ ' + apt.special + '</p>' : '') +
      statusNote +
      '<span onclick="openPropertyDetail(\'' + apt.name.replace(/'/g, "\\'") + '\')" style="display:inline-block; padding:6px 14px; background:' + (allOut ? '#999' : '#FF8200') + '; color:#fff; border-radius:6px; font-size:12px; cursor:pointer; letter-spacing:0.05em; text-transform:uppercase;">' + (allOut ? 'View Details' : 'Learn More') + '</span>' +
      '</div>'
    );
    marker.on('click', function() {
      const card = document.getElementById('map-selected-card');
      document.getElementById('map-card-name').textContent = apt.name + (allOut ? ' (Sold Out)' : '');
      document.getElementById('map-card-details').textContent = resolveBedLabel(apt) + ' · ' + apt.distanceMi + ' mi · ' + apt.amenities.join(', ');
      document.getElementById('map-card-price').textContent = allOut ? 'Sold Out' : '$' + price.toLocaleString() + '/mo';
      document.getElementById('map-card-link').onclick = function() { openPropertyDetail(apt.name); };
      card.style.display = 'block';
    });
  });
}
function buildMap() {
  const el = document.getElementById('leaflet-map');
  if (!el) return;
  if (leafletMap) { leafletMap.invalidateSize(); buildMapMarkers(); return; }
  leafletMap = L.map('leaflet-map', { zoomControl: true, scrollWheelZoom: true }).setView([35.9460, -83.9290], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(leafletMap);
  L.circleMarker([35.9544, -83.9295], { radius: 10, fillColor: '#4B4B4B', color: '#fff', weight: 2, fillOpacity: 0.7 })
    .bindTooltip('UT Campus', { permanent: true, direction: 'bottom', className: 'campus-tooltip' })
    .addTo(leafletMap);
  buildMapMarkers();
}

// ============================================
// LEASE ANALYSIS ENGINE (Enhanced Clause Detection)
// ============================================
const LEASE_CLAUSES = [
  // --- FINANCIAL ---
  { id:'deposit', category:'Financial', label:'Security Deposit', severity:'yellow',
    pattern:/secur(?:ity)?\s*deposit|damage\s*deposit/i,
    extract:/\$[\d,]+(?:\.\d{2})?/,
    advice:'Review the exact amount, conditions for deductions, and the timeline for return after move-out (Tennessee law requires return within 30 days).' },
  { id:'late-fee', category:'Financial', label:'Late Fee', severity:'red',
    pattern:/late\s*(?:fee|charge|penalty)|(?:fee|charge|penalty)\s*(?:for|if)\s*(?:late|overdue)/i,
    extract:/\$[\d,]+(?:\.\d{2})?/,
    advice:'Check the grace period (how many days after the due date), the fee amount, and whether it compounds. Tennessee caps late fees at 10% of monthly rent.' },
  { id:'rent-increase', category:'Financial', label:'Rent Increase', severity:'yellow',
    pattern:/rent\s*(?:increase|adjustment|escalat)|(?:increase|rais|adjust)\s*(?:the\s*)?rent/i,
    extract:/(\d+)\s*%|\$[\d,]+/,
    advice:'Check if there is a cap on annual rent increases and how much notice is required before an increase takes effect.' },
  { id:'app-fee', category:'Financial', label:'Application Fee', severity:'green',
    pattern:/application\s*fee|processing\s*fee|admin(?:istration|istrative)?\s*fee/i,
    extract:/\$[\d,]+(?:\.\d{2})?/,
    advice:'Application fees are typically non-refundable. Confirm the amount and whether it is per person or per unit.' },
  { id:'moveout-charges', category:'Financial', label:'Move-Out Charges', severity:'yellow',
    pattern:/move[\s-]*out\s*(?:fee|charge|cost|inspection)|cleaning\s*fee|carpet\s*(?:cleaning|replacement)/i,
    extract:/\$[\d,]+(?:\.\d{2})?/,
    advice:'Review what cleaning or restoration charges apply at move-out. Document the unit condition at move-in with photos.' },
  { id:'utilities', category:'Financial', label:'Utility Responsibility', severity:'green',
    pattern:/utilit(?:y|ies)|electric(?:ity)?|water|gas|sewer|trash|internet|cable/i,
    extract:null,
    advice:'Clarify exactly which utilities are included in rent vs. tenant-paid. Ask for average monthly utility costs from the landlord.' },

  // --- LEASE TERMS ---
  { id:'auto-renew', category:'Lease Terms', label:'Auto-Renewal', severity:'red',
    pattern:/auto(?:matic(?:ally)?)?[\s-]*renew|(?:shall|will)\s*(?:automatically\s*)?renew|month[\s-]*to[\s-]*month\s*(?:after|upon|at)/i,
    extract:/(\d+)\s*(?:day|month|week)s?\s*(?:prior|before|notice|written)/i,
    advice:'This lease may auto-renew if you don\'t give notice. Mark the notice deadline on your calendar. Missing it could lock you into another term.' },
  { id:'early-term', category:'Lease Terms', label:'Early Termination Penalty', severity:'red',
    pattern:/early\s*terminat|break(?:ing)?\s*(?:the\s*)?lease|(?:terminat|cancel)\s*(?:before|prior|early)|buyout/i,
    extract:/\$[\d,]+(?:\.\d{2})?|(\d+)\s*month/,
    advice:'Understand the exact penalty (often 2 months rent or a flat fee). Check if there are exceptions for military deployment, domestic violence, or health emergencies.' },
  { id:'lease-duration', category:'Lease Terms', label:'Lease Duration', severity:'green',
    pattern:/(?:term|duration|period)\s*(?:of|is|shall\s*be)\s*(?:the\s*|this\s*)?(?:lease|agreement)|(\d+)\s*(?:month|year)\s*(?:lease|term|agreement)/i,
    extract:/(\d+)\s*(?:month|year)/i,
    advice:'Confirm the exact start and end dates. A 12-month lease is standard; shorter terms often carry a premium.' },
  { id:'move-dates', category:'Lease Terms', label:'Move-In / Move-Out Dates', severity:'green',
    pattern:/move[\s-]*in\s*date|move[\s-]*out\s*date|commenc(?:e|ing)|(?:lease|tenancy)\s*(?:begins?|starts?|ends?)/i,
    extract:/(?:jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s*\d{1,2}(?:[,\s]+\d{4})?|\d{1,2}\/\d{1,2}\/\d{2,4}/i,
    advice:'Confirm exact dates and whether partial-month prorating applies. Know exactly when you must vacate to avoid holdover charges.' },

  // --- RESTRICTIONS ---
  { id:'sublease', category:'Restrictions', label:'Sublease / Sublet Policy', severity:'yellow',
    pattern:/subleas|sublet|assign(?:ment)?\s*(?:of|the)?\s*(?:lease|agreement)/i,
    extract:null,
    advice:'Many leases prohibit or restrict subletting. If you might need to sublease, verify whether landlord approval is required and any associated fees.' },
  { id:'pet-policy', category:'Restrictions', label:'Pet Policy', severity:'yellow',
    pattern:/pet(?:s)?\s*(?:policy|fee|deposit|allow|prohibit|restrict)|(?:no|breed)\s*(?:pet|animal|dog|cat)|animal\s*(?:policy|fee|deposit)/i,
    extract:/\$[\d,]+(?:\.\d{2})?|(\d+)\s*(?:lb|pound)/,
    advice:'Review breed/weight restrictions, monthly pet rent, one-time pet deposit, and whether the deposit is refundable. Check if emotional support animals are addressed.' },
  { id:'guest-policy', category:'Restrictions', label:'Guest Policy', severity:'yellow',
    pattern:/guest(?:s)?\s*(?:policy|limit|restrict|overnight|stay)|(?:overnight|extended)\s*(?:guest|visitor)/i,
    extract:/(\d+)\s*(?:day|night|consecutive)/,
    advice:'Check how long guests can stay before they must be added to the lease. Exceeding limits could be considered a lease violation.' },
  { id:'noise-quiet', category:'Restrictions', label:'Noise / Quiet Hours', severity:'green',
    pattern:/quiet\s*hours?|noise\s*(?:policy|restrict|level|complain)|(?:disturb|nuisance)\s*(?:other|neighbor)/i,
    extract:/(\d{1,2}(?::\d{2})?\s*(?:am|pm|a\.m\.|p\.m\.))/i,
    advice:'Know the designated quiet hours and consequences for violations. This protects you as much as your neighbors.' },
  { id:'parking', category:'Restrictions', label:'Parking Rules', severity:'green',
    pattern:/parking\s*(?:space|spot|assign|fee|permit|garage|lot|is|availab|includ)|(?:vehicle|car)\s*(?:parking|registr)/i,
    extract:/\$[\d,]+(?:\.\d{2})?/,
    advice:'Confirm whether parking is included, the monthly fee if not, and any vehicle registration or towing policies.' },
  { id:'modifications', category:'Restrictions', label:'Modification Restrictions', severity:'green',
    pattern:/modif(?:y|ication)|alter(?:ation)?|(?:paint|nail|hole|hang|mount)\s*(?:wall|ceiling)|(?:no|without\s*(?:prior|written))\s*(?:modif|alter)/i,
    extract:null,
    advice:'Most leases restrict wall mounting, painting, or structural changes. Clarify what is allowed and whether you must restore the unit at move-out.' },

  // --- TENANT RIGHTS ---
  { id:'maintenance', category:'Tenant Rights', label:'Maintenance & Repairs', severity:'yellow',
    pattern:/maintenan|repair(?:s)?|(?:landlord|owner|management)\s*(?:shall|will|must)\s*(?:repair|maintain|fix)|work\s*order/i,
    extract:/(\d+)\s*(?:day|hour|business)/,
    advice:'Confirm the landlord\'s timeline for repairs, especially for emergencies (e.g., no heat, plumbing failure). Document all requests in writing.' },
  { id:'entry-notice', category:'Tenant Rights', label:'Entry Notice Requirements', severity:'yellow',
    pattern:/(?:right\s*(?:of|to)\s*)?entry|(?:enter|access)\s*(?:the\s*)?(?:premises|unit|apartment)|(\d+)\s*(?:hour|day)s?\s*(?:notice|prior|advance|before\s*enter)/i,
    extract:/(\d+)\s*(?:hour|day)/,
    advice:'Tennessee requires 24-hour notice before non-emergency entry. Verify this is stated in your lease and know your right to refuse unreasonable entry.' },
  { id:'renters-insurance', category:'Tenant Rights', label:'Renter\'s Insurance', severity:'green',
    pattern:/renter(?:'?s)?\s*insurance|liabilit(?:y)?\s*insurance|(?:require|must\s*(?:have|obtain|carry))\s*(?:renter|insurance)/i,
    extract:/\$[\d,]+(?:\.\d{2})?/,
    advice:'Many complexes require renter\'s insurance (typically $15-30/mo). Check the minimum liability coverage required and whether the landlord must be listed as an interested party.' },
  { id:'mold-habitability', category:'Tenant Rights', label:'Mold / Habitability', severity:'yellow',
    pattern:/mold|mildew|habitab|uninhabitab|health\s*hazard|lead\s*(?:paint|based)/i,
    extract:null,
    advice:'Landlords must maintain habitable conditions. If the lease includes mold disclaimers, understand your rights to remediation and rent abatement.' },

  // --- RED FLAGS ---
  { id:'jury-waiver', category:'Red Flags', label:'Waiver of Jury Trial', severity:'red',
    pattern:/waiv(?:e|er|es|ing)\s*(?:of\s*)?(?:right\s*(?:to\s*)?)?(?:jury|trial)|jury\s*trial\s*waiv/i,
    extract:null,
    advice:'This clause removes your right to a jury trial in disputes. This is a significant legal concession -- consider whether you are comfortable with it.' },
  { id:'arbitration', category:'Red Flags', label:'Binding Arbitration', severity:'red',
    pattern:/(?:binding|mandatory|compulsory)\s*arbitration|(?:agree|consent)\s*(?:to\s*)?arbitrat|arbitration\s*(?:clause|agreement|provision)/i,
    extract:null,
    advice:'Binding arbitration means disputes go to a private arbitrator instead of court. This can limit your legal options and is often more favorable to the landlord.' },
  { id:'liability-waiver', category:'Red Flags', label:'Broad Liability Waiver', severity:'red',
    pattern:/(?:waiv|releas|hold\s*harmless|indemnif)(?:\s+\w+){0,4}\s*(?:landlord|owner|management|company)\s*(?:from|against|for)\s*(?:any\s*(?:and\s*)?all|any|all)\s*(?:liabilit|claim|damage|loss)/i,
    extract:null,
    advice:'A broad liability waiver may release the landlord from responsibility for injuries or property damage, even from their own negligence. Review carefully.' },
  { id:'penalty-amount', category:'Red Flags', label:'Excessive Penalty Amounts', severity:'red',
    pattern:/(?:penalty|fee|charge|fine)\s*(?:of|:)?\s*\$\s*(?:[2-9],\d{3}|\d{2,},\d{3})/i,
    extract:/\$[\d,]+(?:\.\d{2})?/,
    advice:'Penalties exceeding several thousand dollars may be considered unreasonable and unenforceable. Compare this to typical lease penalties in your area.' }
];

function analyzeLease() {
  const text = document.getElementById('lease-text-input').value.trim();
  const resultEl = document.getElementById('lease-analysis-result');
  if (!text) { document.getElementById('lease-text-input').focus(); return; }

  resultEl.innerHTML = '<div style="text-align:center; padding:40px;"><div class="lease-spinner"></div><p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.4); margin-top:16px;">Scanning your lease...</p></div>';
  resultEl.style.display = 'block';

  setTimeout(() => {
    const wordCount = text.split(/\s+/).length;
    const findings = [];

    LEASE_CLAUSES.forEach(clause => {
      const pm = text.match(clause.pattern);
      if (pm) {
        const matchStart = pm.index || 0;
        const forward = text.substring(matchStart, Math.min(text.length, matchStart + pm[0].length + 100));
        let extracted = null;
        if (clause.extract) {
          const m = forward.match(clause.extract);
          if (m) extracted = m[0];
        }
        let snippet = null;
        const start = Math.max(0, matchStart - 40);
        const end = Math.min(text.length, matchStart + pm[0].length + 60);
        snippet = (start > 0 ? '...' : '') + text.substring(start, end).replace(/\n/g, ' ').trim() + (end < text.length ? '...' : '');
        findings.push({ ...clause, extracted, snippet });
      }
    });

    const reds = findings.filter(f => f.severity === 'red');
    const yellows = findings.filter(f => f.severity === 'yellow');
    const greens = findings.filter(f => f.severity === 'green');
    const sorted = [...reds, ...yellows, ...greens];

    const sevColors = { red: '#e53e3e', yellow: '#d69e2e', green: '#38a169' };
    const sevLabels = { red: 'Concern', yellow: 'Review', green: 'Standard' };
    const sevBg = { red: 'rgba(229,62,62,0.08)', yellow: 'rgba(214,158,46,0.08)', green: 'rgba(56,161,105,0.08)' };

    let html = '<div style="border:1px solid rgba(26,26,26,0.08); border-radius:12px; overflow:hidden;">';

    html += '<div style="padding:16px 20px; background:rgba(255,130,0,0.06); border-bottom:1px solid rgba(26,26,26,0.06);">';
    html += '<p class="font-body" style="font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:#FF8200; font-weight:600; margin-bottom:8px;">Lease Analysis Report</p>';
    html += '<p class="font-body" style="font-size:13px; color:rgba(26,26,26,0.6);">Scanned <strong>' + wordCount.toLocaleString() + ' ' + (wordCount === 1 ? 'word' : 'words') + '</strong> &middot; Found <strong>' + sorted.length + ' clause' + (sorted.length !== 1 ? 's' : '') + '</strong></p>';
    html += '</div>';

    html += '<div style="display:flex; border-bottom:1px solid rgba(26,26,26,0.06);">';
    html += '<div style="flex:1; padding:14px 20px; text-align:center; border-right:1px solid rgba(26,26,26,0.06);"><p class="font-body" style="font-size:22px; font-weight:700; color:#e53e3e;">' + reds.length + '</p><p class="font-body" style="font-size:10px; text-transform:uppercase; letter-spacing:0.08em; color:rgba(26,26,26,0.4);">Concerns</p></div>';
    html += '<div style="flex:1; padding:14px 20px; text-align:center; border-right:1px solid rgba(26,26,26,0.06);"><p class="font-body" style="font-size:22px; font-weight:700; color:#d69e2e;">' + yellows.length + '</p><p class="font-body" style="font-size:10px; text-transform:uppercase; letter-spacing:0.08em; color:rgba(26,26,26,0.4);">To Review</p></div>';
    html += '<div style="flex:1; padding:14px 20px; text-align:center;"><p class="font-body" style="font-size:22px; font-weight:700; color:#38a169;">' + greens.length + '</p><p class="font-body" style="font-size:10px; text-transform:uppercase; letter-spacing:0.08em; color:rgba(26,26,26,0.4);">Standard</p></div>';
    html += '</div>';

    html += '<div style="padding:20px;">';

    if (sorted.length === 0) {
      html += '<div style="text-align:center; padding:24px;">';
      html += '<p class="font-body" style="font-size:14px; color:rgba(26,26,26,0.5); margin-bottom:8px;">No specific clauses detected.</p>';
      html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.35); line-height:1.6;">This could mean the text is too short or doesn\'t contain standard lease language. Try pasting the full lease agreement.</p>';
      html += '</div>';
    } else {
      sorted.forEach((f, i) => {
        const c = sevColors[f.severity];
        const bg = sevBg[f.severity];
        const sLabel = sevLabels[f.severity];
        html += '<div style="margin-bottom:' + (i < sorted.length - 1 ? '16' : '0') + 'px; border:1px solid rgba(26,26,26,0.06); border-radius:10px; overflow:hidden;">';
        html += '<div style="padding:12px 16px; display:flex; align-items:center; justify-content:space-between; background:' + bg + ';">';
        html += '<p class="font-body" style="font-weight:600; font-size:13px; color:#1A1A1A;">' + f.label + '</p>';
        html += '<span class="font-body" style="font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:' + c + '; background:' + c + '18; padding:3px 10px; border-radius:20px;">' + sLabel + '</span>';
        html += '</div>';
        html += '<div style="padding:14px 16px;">';
        if (f.extracted) {
          html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.5); margin-bottom:8px;">Detected value: <strong style="color:#1A1A1A;">' + f.extracted + '</strong></p>';
        }
        if (f.snippet) {
          html += '<div style="background:rgba(26,26,26,0.03); border-left:3px solid ' + c + '; padding:10px 14px; border-radius:0 6px 6px 0; margin-bottom:10px;">';
          html += '<p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.5); line-height:1.6; font-style:italic;">"' + f.snippet.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '"</p>';
          html += '</div>';
        }
        html += '<p class="font-body" style="font-size:12px; color:rgba(26,26,26,0.55); line-height:1.6;">' + f.advice + '</p>';
        html += '</div></div>';
      });
    }

    html += '<p class="font-body" style="font-size:11px; color:rgba(26,26,26,0.3); margin-top:20px; font-style:italic; line-height:1.6;">This analysis uses pattern detection and is not legal advice. For binding interpretations, consult a licensed attorney.</p>';
    html += '</div></div>';

    resultEl.innerHTML = html;
  }, 1200);
}

// ============================================
// SCROLL REVEAL OBSERVER
// ============================================
function initRevealObserver() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('in-view');
      }
    });
  }, { threshold: 0.15, root: document.getElementById('app-scroll') });
  
  document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
}

// ============================================
// PROFILE INFO
// ============================================
function updateProfileInfo() {
  let first = document.getElementById('input-first').value.trim();
  let last = document.getElementById('input-last').value.trim();
  if (!first || !last) {
    const saved = getSavedUser();
    if (saved) { first = saved.firstName || ''; last = saved.lastName || ''; }
  }
  if (first && last) {
    document.getElementById('profile-name').textContent = first + ' ' + last;
    document.getElementById('profile-initials').textContent = first[0].toUpperCase() + last[0].toUpperCase();
  }
}

// ============================================
// LOGIN PERSISTENCE (localStorage)
// ============================================
function getSavedUser() {
  try { return JSON.parse(localStorage.getItem('smartlease_user')); } catch(e) { return null; }
}
function saveUserInfo() {
  const firstName = document.getElementById('input-first').value.trim();
  const lastName = document.getElementById('input-last').value.trim();
  const email = document.getElementById('input-email').value.trim();
  const phone = document.getElementById('input-phone').value.trim();
  if (firstName && lastName && email) {
    localStorage.setItem('smartlease_user', JSON.stringify({ firstName, lastName, email, phone }));
    userName = firstName;
  }
}
function saveSurveyAnswers() {
  const amenities = getSelectedAmenities();
  const priorities = getPriorityOrder();
  const data = {
    bedroom: selectedBedroom,
    budgetMin: getBudgetMin(),
    budgetMax: getBudgetMax(),
    amenities: amenities,
    distance: selectedDistance,
    priorities: priorities
  };
  localStorage.setItem('smartlease_survey', JSON.stringify(data));
}
function loadLoginPersistence() {
  const user = getSavedUser();
  const survey = (function() { try { return JSON.parse(localStorage.getItem('smartlease_survey')); } catch(e) { return null; } })();
  if (user && survey) {
    userName = user.firstName;
    document.getElementById('input-first').value = user.firstName || '';
    document.getElementById('input-last').value = user.lastName || '';
    document.getElementById('input-email').value = user.email || '';
    document.getElementById('input-phone').value = user.phone || '';
    selectedBedroom = survey.bedroom || null;
    selectedDistance = survey.distance || null;
    if (survey.budgetMin) document.getElementById('budget-min').value = survey.budgetMin;
    if (survey.budgetMax) document.getElementById('budget-max').value = survey.budgetMax;
    renderResults();
    const current = document.getElementById(currentSection);
    current.style.opacity = '0';
    setTimeout(() => {
      current.classList.remove('active');
      current.style.display = 'none';
      const results = document.getElementById('section-results');
      results.style.display = 'flex';
      results.style.opacity = '0';
      results.offsetHeight;
      setTimeout(() => {
        results.classList.add('active');
        results.style.opacity = '1';
      }, 50);
      currentSection = 'section-results';
      document.getElementById('progress-bar').classList.remove('visible');
      showBottomNav();
      updateProfileInfo();
      updateFavoritesButton();
    }, 100);
  } else if (user) {
    document.getElementById('input-first').value = user.firstName || '';
    document.getElementById('input-last').value = user.lastName || '';
    document.getElementById('input-email').value = user.email || '';
    document.getElementById('input-phone').value = user.phone || '';
    userName = user.firstName;
  }
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  // Focus first input when story section appears
  const observer = new MutationObserver((mutations) => {
    mutations.forEach(m => {
      if (m.target.id === 'section-story' && m.target.classList.contains('active')) {
        setTimeout(() => document.getElementById('input-first').focus(), 600);
      }
    });
  });
  
  observer.observe(document.getElementById('section-story'), { attributes: true, attributeFilter: ['class'] });
  updateBudgetRange();
  populateRoommateLiving();
  populateReviewDropdowns();
  loadLoginPersistence();
  retryPendingSubmissions();
});
</script>

</body>
</html>